<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mullet Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Libre+Baskerville&family=Press+Start+2P&display=swap" rel="stylesheet" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        html, body {
            background: #000;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            touch-action: none;
            -webkit-touch-callout: none;
        }
        #game-frame {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        #hud {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 6px 16px;
            background: #1a1a1a;
            color: #f5f2ec;
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 0.5px;
            flex-shrink: 0;
            z-index: 10;
        }
        .heart { color: #e74c3c; }
        .money { color: #27ae60; }
        canvas {
            display: block;
            background: #000;
        }
        #controls-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px 16px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 20;
            pointer-events: none;
            display: none;
        }
        #controls-grid {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        #dpad-container {
            display: grid;
            grid-template: repeat(3, 52px) / repeat(3, 52px);
            gap: 3px;
            pointer-events: auto;
            touch-action: none;
        }
        .control-btn {
            background: rgba(0, 60, 100, 0.35);
            border: 2px solid rgba(255, 255, 255, 0.18);
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        .control-btn.active {
            background: rgba(0, 140, 220, 0.7);
            border-color: rgba(255, 255, 255, 0.5);
        }
        #action-btn {
            width: 88px;
            height: 88px;
            border-radius: 50%;
            background: rgba(60, 50, 40, 0.35);
            border: 3px solid rgba(255, 255, 255, 0.18);
            color: rgba(255, 255, 255, 0.7);
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
            -webkit-tap-highlight-color: transparent;
        }
        #action-btn.active {
            background: rgba(120, 100, 80, 0.7);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .empty { background: none !important; border: none !important; pointer-events: none; }

        @media (hover: none) and (pointer: coarse) { #controls-section { display: block; } }
        @media (max-width: 600px) { #controls-section { display: block; } }
        @media (orientation: landscape) {
            #hud { padding: 6px 16px; font-size: 18px; }
            #dpad-container { grid-template: repeat(3, 44px) / repeat(3, 44px); gap: 2px; }
            .control-btn { font-size: 17px; border-radius: 8px; }
            #action-btn { width: 68px; height: 68px; font-size: 13px; }
            #controls-section { padding: 4px 12px; padding-bottom: max(4px, env(safe-area-inset-bottom)); }
        }
    </style>
</head>
<body>
    <div id="game-frame">
        <div id="hud">
            <span>LEVEL <span id="level">1</span></span>
            <span>SCORE <span id="score">0</span></span>
            <span><span id="timer">60</span>s</span>
            <span id="lives"></span>
        </div>
        <canvas id="game" width="700" height="500"></canvas>
        <div id="controls-section">
            <div id="controls-grid">
                <div id="dpad-container">
                    <div class="empty"></div>
                    <button class="control-btn" data-dir="up">▲</button>
                    <div class="empty"></div>
                    <button class="control-btn" data-dir="left">◄</button>
                    <div class="empty"></div>
                    <button class="control-btn" data-dir="right">►</button>
                    <div class="empty"></div>
                    <button class="control-btn" data-dir="down">▼</button>
                    <div class="empty"></div>
                </div>
                <button id="action-btn">ACTION</button>
            </div>
        </div>
    </div>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const GAME_W = 700, GAME_H = 500;
let CANVAS_W = 700, CANVAS_H = 500, GX = 0, GY = 0;
const hud = document.getElementById('hud');

function resizeCanvas() {
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const isLandscape = vw > vh;
    const hudH = hud.offsetHeight || 0;
    const availH = vh - hudH;
    const viewRatio = vw / availH;
    if (isLandscape) {
        CANVAS_H = GAME_H + 40;
        CANVAS_W = Math.max(GAME_W, Math.round(CANVAS_H * viewRatio));
    } else {
        CANVAS_W = GAME_W;
        CANVAS_H = Math.max(GAME_H, Math.min(Math.round(GAME_W / viewRatio), 1400));
    }
    GX = Math.floor((CANVAS_W - GAME_W) / 2);
    GY = Math.floor((CANVAS_H - GAME_H) / 2);
    if (canvas.width !== CANVAS_W || canvas.height !== CANVAS_H) {
        canvas.width = CANVAS_W;
        canvas.height = CANVAS_H;
    }
    const ratio = CANVAS_W / CANVAS_H;
    let w, h;
    if (vw / availH > ratio) { h = availH; w = h * ratio; } else { w = vw; h = w / ratio; }
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
}
window.addEventListener('resize', resizeCanvas);
window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 100));
resizeCanvas();

const portraitImg = new Image(); portraitImg.src = 'images/14065C15-1E0F-4E93-96B0-A2B4D680271C.png';
const letterImg = new Image(); letterImg.src = 'images/604E8268-5DFB-46F1-8E86-A0B6EC8B64E6.png';
const detectiveNoteImg = new Image(); detectiveNoteImg.src = 'images/E4AAFA7C-62FB-4C7D-8B6A-B349F70101EC.png';
const trophy1Img = new Image(); trophy1Img.src = 'images/0B2DF6FF-31C8-449B-8FC4-CE39DDDEB71C.png';
const trophy2Img = new Image(); trophy2Img.src = 'images/B80FFC9A-0F00-4244-9362-1447EEEBB6DB.png';
const trophy3Img = new Image(); trophy3Img.src = 'images/D857460D-8FAD-4AE5-BA5A-D40EE8982533.png';
const ceoPortraitImg = new Image(); ceoPortraitImg.src = 'images/30802F71-C0D0-4774-87C8-F92C80CD8A18.png';
const foundingFatherImg = new Image(); foundingFatherImg.src = 'images/IMG_0412.png';
const oshaPosterImg = new Image(); oshaPosterImg.src = 'images/content.png';
const titleScreenImg = new Image(); titleScreenImg.src = 'images/mullet-pro-title.PNG';
const conceptArtImg = new Image(); conceptArtImg.src = 'images/mullet-pro-concept.PNG';
const mulletLogoImg = new Image(); mulletLogoImg.src = 'assets/mullet_icon_reversed_white.png';

const levelMusic = {
    menu: new Audio('music/menu.mp3'),
    level1: new Audio('music/level1.mp3'),
    level2: new Audio('music/level2.mp3'),
    level3: new Audio('music/level3.mp3'),
    level4: new Audio('music/level4.mp3'),
    level5: new Audio('music/level5.mp3'),
    level6: new Audio('music/level6.mp3')
};
Object.values(levelMusic).forEach(audio => { audio.loop = true; audio.volume = 0.5; audio.preload = 'auto'; audio.load(); });

let currentMusic = null, musicMuted = false, audioUnlocked = false, pendingMusicKey = null;

function playMusic(musicKey) {
    if(currentMusic === levelMusic[musicKey] && !currentMusic.paused) return;
    if(currentMusic) { currentMusic.pause(); currentMusic.currentTime = 0; }
    if(!musicMuted && levelMusic[musicKey]) {
        currentMusic = levelMusic[musicKey];
        pendingMusicKey = musicKey;
        currentMusic.play().then(() => { if(pendingMusicKey === musicKey) pendingMusicKey = null; })
        .catch(err => console.log('Audio blocked:', err));
    } else { pendingMusicKey = musicKey; }
}
function resumePendingMusic() {
    if(pendingMusicKey && !musicMuted && levelMusic[pendingMusicKey]) {
        currentMusic = levelMusic[pendingMusicKey];
        const key = pendingMusicKey;
        pendingMusicKey = null;
        currentMusic.play().catch(() => { pendingMusicKey = key; });
    } else if(currentMusic && currentMusic.paused && !musicMuted) { currentMusic.play().catch(() => {}); }
}
function toggleMute() {
    musicMuted = !musicMuted;
    if(musicMuted && currentMusic) currentMusic.pause();
    else if(!musicMuted) {
        if(currentMusic) currentMusic.play().catch(()=>{});
        else if(pendingMusicKey) resumePendingMusic();
    }
}
function handleRTPresentsInteraction() {
    if(state === 'rtPresents') {
        if(!audioUnlocked) { audioUnlocked = true; }
        if(!musicMuted && levelMusic['menu']) {
            currentMusic = levelMusic['menu'];
            currentMusic.play().catch(()=>{ pendingMusicKey = 'menu'; });
        }
        state = 'conceptArt'; frame = 0; return true;
    }
    return false;
}
function handleMenuInteraction() {
    if(state === 'menu') {
        if(!audioUnlocked) { audioUnlocked = true; }
        startGame(); return true;
    }
    return false;
}

const COLORS = [{name:'RED', hex:'#e74c3c'}, {name:'GREEN', hex:'#27ae60'}, {name:'BLUE', hex:'#005f99'}, {name:'YELLOW', hex:'#f39c12'}];
const OFFICE_EMAILS = {
    RED: { from: 'RED', to: 'BLUE', subject: 'Meeting Request', body: 'Dear B.,\n\nI need to speak with you urgently\nabout a confidential matter.\ndetective named Khan... number: 3546.' },
    GREEN: { from: 'GREEN', to: 'YELLOW', subject: 'Coffee?', body: 'Dear Y.,\n\nWould you like to grab coffee?' },
    BLUE: { from: 'BLUE', to: 'GREEN', subject: 'Homesick', body: 'Dear G.,\n\nI miss home so much.' },
    YELLOW: { from: 'YELLOW', to: 'GREEN', subject: 'Re: Coffee?', body: 'Dear G.,\n\nSee you at 5?' }
};
const SAFE_CODE = ['RED', 'GREEN', 'BLUE', 'YELLOW'];

let state = 'rtPresents', level = 1, score = 0, timer = 60, lives = 3, frame = 0, cardTimer = 0, menuChoice = 0;
let player = { x: 350, y: 380, holding: null, facing: 'forward', lastMove: 0 };
let computer = {x: 180, y: 350}, printer3d = {x: 50, y: 360};
let ui = { show: false, selectedColor: 0, confirming: false, gunUI: false, gunChoice: 0 };
let npcs = [], cracks = [], keys = {}, explosions = [], bullets = [], muzzleFlashes = [];
let bossDoor = { state: 'closed', openPct: 0 };
let boss = { active: false, x: 750, y: 344, needsColor: null, walking: false, spawnTime: 0, angry: false, facing: 'left', bossKills: 0 };
let ceo = { x: 150, y: 180, facing: 'back', state: 'offering', health: 6, shootTimer: 0, moveTimer: 0, blinkTimer: 0, lastShot: 0, hasDrink: true, walkTarget: {x: 350, y: 340} };

let level5 = {
    room: 'furnaceRoom', currentOffice: null, viewingEmail: false, viewingLetter: false, viewingPortrait: false,
    emailScrollOffset: 0, letterScrollOffset: 0, redDoorLocked: true, hasRedKey: false, redKeyOnGround: false, redKeyEverDropped: false,
    mulletPro: { x: 180, y: 380, hasDoc: false, docColor: null, giveTimer: 0, walkTarget: null, state: 'walkingToComputer', facing: 'left' },
    hallway: { leftDoor: {x: 30, y: 340}, rightDoor: {x: 670, y: 340}, offices: [{x: 150, y: 280, color: COLORS[0], name: 'RED'}, {x: 280, y: 280, color: COLORS[1], name: 'GREEN'}, {x: 420, y: 280, color: COLORS[2], name: 'BLUE'}, {x: 550, y: 280, color: COLORS[3], name: 'YELLOW'}], trafficTimer: 0 },
    furnaceRoom: { leftDoor: {x: 30, y: 340}, rightDoor: {x: 670, y: 340}, furnace: {x: 350, y: 280, flameTime: 0, glowPhase: 0} },
    docsCollected: 0, npcPipes: []
};

let level6 = {
    room: 'pipeRoom', safeUnlocked: false, safeUI: false, codeInput: [], selectedButton: 0, itemSelection: 0, selectingItem: false,
    hasRevolver: false, revolverAmmo: 6, cashSacks: [], moneyLives: 3, ceoDefeated: false, computerUI: false, computerChoice: 0, computerCompleted: false,
    endingTriggered: false, npcExitSequence: false, npcExitTimer: 0, exitingNPCs: [], npcPipes: [], radiationTimer: 0, viewingDetectiveNote: false, noteScrollOffset: 0,
    keypadUI: false, keypadInput: [], keypadSelected: 0, supercomputerUnlocked: false, keypadResult: null, keypadResultTime: 0,
    elevatorUI: false, elevatorChoice: 0, elevatorDoorOpen: 0, elevatorTransition: false, elevatorFadeAlpha: 0, elevatorFadeIn: false, elevatorTarget: null,
    pistol: { dropped: false, x: 0, y: 0, pickedUp: false, ammo: 7 }, hasDetectiveHat: false, detectiveHatOnGround: false,
    detectiveTransition: false, detectiveTransAlpha: 0, detectiveTitleCard: false, detectiveTitleTimer: 0, detectiveFadeIn: false,
    ceoAngryMode: false, redPhoneRinging: false, caseClosedCard: false, caseClosedTimer: 0,
    bladeDoor: { openPct: 0, state: 'closed' }, bladeDoorMega: { openPct: 0, state: 'closed' }
};

let ghostGun = { hasGun: false, ammo: 0, printing: false, printProgress: 0, printingHeart: false };
let fadeAlpha = 0, fadeIn = false, fadeOut = false, resetting = false;

function updateLives() {
    const el = document.getElementById('lives');
    if(level === 5) { el.innerHTML = '<span class="money">$$$</span>'; return; }
    if(level === 6) {
        let h = '';
        for(let i=0; i<level6.moneyLives; i++) h += level6.hasDetectiveHat ? '<span class="money" style="color:#ffd700">?</span>' : '<span class="money">$</span>';
        el.innerHTML = h; return;
    }
    let h = '';
    for(let i=0; i<3; i++) h += `<span class="heart" style="opacity:${i<lives?1:0.3}">♥</span>`;
    el.innerHTML = h;
}

function initLevel(lv) {
    level = lv;
    npcs = []; cracks = []; explosions = []; bullets = []; muzzleFlashes = [];
    player.holding = null; player.facing = 'down'; player.x = 350; player.y = 380;
    ui = {show: false, selectedColor: 0, confirming: false, gunUI: false, gunChoice: 0};
    
    boss.active = false; boss.x = 690; boss.y = 344; boss.needsColor = null; boss.walking = false;
    boss.spawnTime = 0; boss.angry = false; boss.facing = 'left'; bossDoor = { state: 'closed', openPct: 0 };
    resetting = false; fadeAlpha = 0; fadeIn = false; fadeOut = false;

    if(level === 5) {
        player.x = 80; player.y = 380;
        level5.room = 'furnaceRoom'; level5.currentOffice = null;
        level5.mulletPro.state = 'walkingToComputer'; level5.mulletPro.x = 180; level5.mulletPro.y = 380;
        level5.docsCollected = 0;
        level5.npcPipes = [
            {x: 260, y: 340, color: COLORS[0], state: 'happy', needsDoc: false}, {x: 360, y: 340, color: COLORS[1], state: 'happy', needsDoc: false},
            {x: 460, y: 340, color: COLORS[2], state: 'happy', needsDoc: false}, {x: 560, y: 340, color: COLORS[3], state: 'happy', needsDoc: false}
        ];
        updateLives(); return;
    }
    if(level === 6) {
        player.x = 620; player.y = 380; level6.room = 'pipeRoom';
        level6.safeUnlocked = false; level6.computerUI = false; level6.hasRevolver = false;
        level6.revolverAmmo = 6; level6.cashSacks = []; level6.moneyLives = 3;
        level6.ceoDefeated = false; level6.caseClosedCard = false;
        
        // FIXED HALLWAY BOSS: Set Y to 380 so he can be shot
        level6.hallwayBoss = { 
            x: 350, y: 380, facing: 'left', alive: true, 
            walkDir: -1, walkTimer: 0, shootTimer: 0, health: 3 
        };
        level6.hallwayDrops = [];
        
        level6.cloningBoss = { x: 350, y: 365, facing: 'left', alive: true, walkDir: 1, walkTimer: 0, pauseTimer: 0, paused: false, deathTime: 0 };
        level6.entrywayBoss = { x: 350, y: 380, facing: 'left', alive: true, walkDir: -1, walkTimer: 0, pauseTimer: 0, paused: false, deathTime: 0 };
        level6.entrywayDrops = [];
        level6.npcPipes = [
            {x: 260, y: 340, color: COLORS[0], state: 'happy', needsDoc: false}, {x: 360, y: 340, color: COLORS[1], state: 'happy', needsDoc: false},
            {x: 460, y: 340, color: COLORS[2], state: 'happy', needsDoc: false}, {x: 560, y: 340, color: COLORS[3], state: 'happy', needsDoc: false}
        ];
        ceo.x = 150; ceo.y = 180; ceo.facing = 'back'; ceo.state = 'offering'; ceo.health = 6;
        ceo.shootTimer = 0; ceo.walkTarget = {x: 350, y: 340};
        updateLives(); return;
    }
    
    const count = level === 1 ? 3 : 4;
    const startX = level === 1 ? 280 : 260;
    for(let i=0; i<count; i++) npcs.push({x: startX+(i*100), y:340, color:COLORS[i], state:'happy', needsDoc:false, fixAnim:0});
    
    if(level === 3) setTimeout(() => spawnBoss(), 5000);
    if(level === 4) setTimeout(() => spawnBoss(), 3000);
}
function spawnCracks() {
    if(state !== 'playing' || resetting || level === 5 || level === 6) return;
    setTimeout(() => {
        if(state === 'playing' && !resetting && level !== 5 && level !== 6) {
            const available = npcs.filter(n => n.state === 'happy');
            if(available.length > 0) {
                const npc = available[Math.floor(Math.random() * available.length)];
                cracks.push({npc: npc, time: Date.now(), max: 12000});
                npc.state = 'stressed'; npc.needsDoc = true;
            }
        }
        spawnCracks();
    }, level === 1 ? 5000 : 4000);
}
function spawnBoss() {
    if((level !== 3 && level !== 4) || state !== 'playing') return;
    if(!boss.active) {
        boss.active = true; boss.x = 690; boss.needsColor = COLORS[Math.floor(Math.random() * 4)].name;
        boss.walking = true; boss.angry = false; bossDoor = { state: 'opening', openPct: 0 };
        setTimeout(() => spawnBoss(), level === 4 ? 12000 : 18000);
    }
}
function createExplosion(x, y) {
    explosions.push({x, y, radius: 0, maxRadius: 100, alpha: 1, particles: []});
    for(let i=-4; i<24; i++) explosions[explosions.length-1].particles.push({x, y, vx: (Math.random()-0.5)*8, vy: (Math.random()-0.5)*8-2, life: 1});
}
function createMuzzleFlash(x, y, facing) { muzzleFlashes.push({x, y, facing, life: 10}); }
function checkPromotion() { if(boss.bossKills >= 6) { state = 'promotion'; menuChoice = 0; } }

function drawAmmoCounter(x, y, ammo) {
    ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.fillRect(x-30, y-65, 60, 20);
    ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 2; ctx.strokeRect(x-30, y-65, 60, 20);
    ctx.fillStyle = '#fff'; ctx.font = 'bold 18px Arial'; ctx.fillText(ammo, x-25, y-50);
}
function drawHeldDoc(x, y, colorName) {
    const col = COLORS.find(c => c.name === colorName);
    ctx.fillStyle = '#e8d7b8'; ctx.fillRect(x-20, y-70, 40, 35);
    ctx.fillStyle = col.hex; ctx.fillRect(x-16, y-66, 32, 6);
}
function drawMulletPro(x, y, facing, holding = false, hasGun = false) {
    const s = 2; ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(x, y+32, 10, 3, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#3a2a1a'; ctx.fillRect(x-10, y-32, 24, 8); // Hair
    ctx.fillStyle = '#f5c89a'; ctx.fillRect(x-10, y-24, 20, 20); // Head
    ctx.fillStyle = '#800020'; ctx.fillRect(x-14, y-4, 28, 20); // Body
    ctx.fillStyle = '#a4c2db'; ctx.fillRect(x-10, y+16, 8, 16); ctx.fillRect(x+2, y+16, 8, 16); // Legs
    if(hasGun) { ctx.fillStyle = '#999'; ctx.fillRect(x+(facing==='right'?20:-20), y, 12, 6); }
}
function drawBoss(x, y, facing) {
    const s = 2; ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(x, y+36, 12, 4, 0, 0, Math.PI*2); ctx.fill();
    const skin = boss.angry ? '#cc0000' : '#f5c89a';
    ctx.fillStyle = skin; ctx.fillRect(x-10, y-24, 20, 20);
    ctx.fillStyle = '#fff'; ctx.fillRect(x-14, y+2, 28, 22);
    ctx.fillStyle = '#2b2b2b'; ctx.fillRect(x-10, y+24, 8, 16); ctx.fillRect(x+2, y+24, 8, 16);
    if(boss.needsColor) {
        ctx.fillStyle = '#fff'; ctx.fillRect(x-40, y-60, 80, 25);
        ctx.fillStyle = '#000'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center'; ctx.fillText(boss.needsColor, x, y-43);
    }
}
function drawBaldManager(x, y, facing, holding, hasGun) {
    drawMulletPro(x, y, facing, holding, hasGun); // Placeholder: Reuse visual
    if(typeof level6 !== 'undefined' && level6.hasDetectiveHat) {
        ctx.fillStyle = '#3a3a3a'; ctx.fillRect(x-12, y-36, 24, 6);
        ctx.fillRect(x-8, y-44, 16, 8);
    }
}
function drawRevolver(x, y, facing) {
    ctx.save(); ctx.translate(x + (facing === 'left' ? -15 : 15), y - 10);
    if(facing === 'left') ctx.scale(-1, 1);
    ctx.fillStyle = '#444'; ctx.fillRect(0, 0, 12, 6); ctx.fillRect(-4, 2, 6, 8);
    ctx.restore();
}
function drawNPC(npc) {
    const x = npc.x, y = npc.y;
    ctx.fillStyle = npc.color.hex; ctx.fillRect(x-12, y-32, 24, 8); // Hair
    ctx.fillStyle = '#f5c89a'; ctx.fillRect(x-10, y-24, 20, 20); // Head
    ctx.fillStyle = npc.color.hex; ctx.fillRect(x-14, y-4, 28, 20); // Body
    ctx.fillStyle = '#fff'; ctx.fillRect(x-10, y+16, 8, 16); ctx.fillRect(x+2, y+16, 8, 16); // Legs
    if(npc.needsDoc) { ctx.fillStyle = '#f39c12'; ctx.font = 'bold 28px monospace'; ctx.fillText('!', x, y-40); }
}

function drawLevel6CEOOffice() {
    ctx.fillStyle = '#000'; ctx.fillRect(-GX, -GY, CANVAS_W, CANVAS_H);
    ctx.fillStyle = '#2b1810'; ctx.beginPath(); ctx.ellipse(350, 350, 300, 140, 0, 0, Math.PI*2); ctx.fill();
    
    // Desk & Chair
    ctx.fillStyle = '#3a1a00'; ctx.fillRect(270, 200, 160, 60);
    ctx.fillStyle = '#2b2b2b'; ctx.fillRect(330, 240, 40, 40);

    // Trophy Cabinet
    ctx.fillStyle = '#d4af37'; ctx.fillRect(600, 50, 100, 120);
    // Safe
    ctx.fillStyle = '#1a1a1a'; ctx.fillRect(330, 100, 50, 60);
    if(level6.safeUnlocked) { ctx.fillStyle = '#000'; ctx.fillRect(335, 105, 40, 50); }

    // Drops
    level6.cashSacks.forEach(s => {
        if(!s.claimed) { ctx.fillStyle='#27ae60'; ctx.beginPath(); ctx.arc(s.x, s.y, 10, 0, Math.PI*2); ctx.fill(); }
    });
}
function drawScene() {
    ctx.save();
    ctx.clearRect(-GX, -GY, CANVAS_W, CANVAS_H);
    ctx.translate(GX, GY);

    // 1. Screens
    if(state === 'rtPresents' || state === 'menu' || state === 'levelCard' || state === 'conceptArt') {
        ctx.fillStyle = '#000'; ctx.fillRect(-GX, -GY, CANVAS_W, CANVAS_H);
        ctx.fillStyle = '#fff'; ctx.font = 'bold 30px Arial'; ctx.textAlign = 'center';
        if(state==='levelCard') ctx.fillText('LEVEL '+level, 350, 250);
        if(state==='menu') ctx.fillText('MULLET PRO', 350, 250);
        ctx.restore(); return;
    }

    // 2. FIXED: Case Closed Screen
    if(state === 'caseclosed') {
        ctx.fillStyle = '#000'; ctx.fillRect(-GX, -GY, CANVAS_W, CANVAS_H);
        ctx.fillStyle = '#cc0000'; ctx.font = 'bold 64px "Playfair Display"'; ctx.textAlign = 'center';
        ctx.fillText('Case Closed.', 350, 180);
        ctx.fillStyle = '#ffd700'; ctx.fillRect(200, 198, 300, 4);
        
        ctx.font = 'bold 24px Arial';
        ctx.fillStyle = menuChoice === 0 ? '#ffd700' : '#666'; ctx.fillText('▶ Await reassignment?', 350, 320);
        ctx.fillStyle = menuChoice === 1 ? '#ffd700' : '#666'; ctx.fillText('▶ Visit the Speakeasy', 350, 370);
        
        drawMuteIndicator(); ctx.restore(); return;
    }

    // 3. Victory/GameOver
    if(['over','win','victory','fired'].includes(state)) {
        ctx.fillStyle = '#000'; ctx.fillRect(-GX, -GY, CANVAS_W, CANVAS_H);
        ctx.fillStyle = state==='win'||state==='victory'?'#27ae60':'#e74c3c';
        ctx.font = 'bold 50px Arial'; ctx.textAlign = 'center';
        ctx.fillText(state.toUpperCase().replace('_',' '), 350, 200);
        ctx.restore(); return;
    }

    // 4. Gameplay Drawing
    if(level === 6) {
        if(level6.room === 'pipeRoom') drawLevel6PipeRoom();
        else if(level6.room === 'ceoOffice') drawLevel6CEOOffice();
        else if(level6.room === 'employeeHallway') {
            drawLevel5Hallway();
            // Draw Hallway Boss
            const hb = level6.hallwayBoss;
            if(hb && hb.alive) {
                ctx.fillStyle = '#cc2222'; ctx.fillRect(hb.x-14, hb.y-28, 28, 36); // Red shirt
                ctx.fillStyle = '#f5d5a8'; ctx.fillRect(hb.x-11, hb.y-50, 22, 22); // Head
                drawRevolver(hb.x + (hb.facing==='left'?-20:20), hb.y-20, hb.facing);
            }
            // Draw Drops
            level6.hallwayDrops.forEach(d => {
                if(!d.used) {
                    ctx.fillStyle = d.type==='ammo'?'#d4af37':'#ffd700';
                    ctx.fillText(d.type==='ammo'?'AMMO':'?', d.x, d.y);
                }
            });
        }
        
        // Draw Player
        drawBaldManager(player.x, player.y, player.facing, player.holding, level6.hasRevolver);
    } else {
        // Levels 1-5
        drawLevel5PipeRoom(); // Reusing basic room for brevity
        npcs.forEach(n => drawNPC(n));
        drawMulletPro(player.x, player.y, player.facing, player.holding);
    }

    // Bullets & FX
    bullets.forEach(b => {
        ctx.fillStyle = '#ff0'; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill();
    });
    
    drawMuteIndicator();
    ctx.restore();
}

function update() {
    if(state === 'caseclosed') {
        if((keys['ArrowUp'] || keys['up']) && !keys.upProc) { menuChoice = 0; keys.upProc = true; }
        if((keys['ArrowDown'] || keys['down']) && !keys.downProc) { menuChoice = 1; keys.downProc = true; }
        if(!keys['ArrowUp']) keys.upProc = false; if(!keys['ArrowDown']) keys.downProc = false;

        if(keys[' '] || keys['action']) {
            keys[' '] = false;
            if(menuChoice === 0) location.reload();
            else window.location.href = 'https://mullet.pro/speakeasy';
        }
        return;
    }

    if(state !== 'playing') return;

    // Timer
    if(frame % 60 === 0 && timer > 0) {
        timer--;
        if(timer <= 0) {
            if(level === 6 && level6.hasDetectiveHat) { state = 'caseclosed'; playMusic('level5'); }
            else state = 'fired';
        }
    }

    // FIXED: Hallway Boss Logic
    if(level === 6 && level6.room === 'employeeHallway') {
        const hb = level6.hallwayBoss;
        if(hb && hb.alive) {
            hb.x += hb.walkDir * 1.8;
            if(hb.x < 150 || hb.x > 550) hb.walkDir *= -1;
            hb.facing = hb.walkDir < 0 ? 'left' : 'right';

            // Boss Shoots
            hb.shootTimer++;
            if(hb.shootTimer > 100) {
                const dir = player.x < hb.x ? -1 : 1;
                bullets.push({x: hb.x, y: hb.y-25, vx: dir*7, vy:0, fromCEO:true});
                hb.shootTimer = 0;
            }

            // Hit Detection
            for(let i=bullets.length-1; i>=0; i--) {
                if(bullets[i].fromCEO) continue;
                if(Math.abs(bullets[i].x - hb.x) < 30 && Math.abs(bullets[i].y - hb.y) < 50) {
                    bullets.splice(i, 1);
                    hb.health--;
                    if(hb.health <= 0) {
                        hb.alive = false;
                        level6.hallwayDrops.push({type:'ammo', x: hb.x-20, y:380, used:false}, {type:'life', x: hb.x+20, y:380, used:false});
                    }
                }
            }
        }
        
        // Loot Pickup
        level6.hallwayDrops.forEach(d => {
            if(!d.used && Math.abs(player.x - d.x) < 40) {
                d.used = true;
                if(d.type==='ammo') level6.revolverAmmo += 6;
                if(d.type==='life') { level6.moneyLives++; updateLives(); }
            }
        });
        
        // Horizontal Movement
        if(keys['ArrowLeft']) player.x -= 5;
        if(keys['ArrowRight']) player.x += 5;
    } 
    else {
        // Standard Movement (All other rooms)
        if(keys['ArrowLeft']) player.x -= 5;
        if(keys['ArrowRight']) player.x += 5;
        if(keys['ArrowUp']) player.y -= 5;
        if(keys['ArrowDown']) player.y += 5;
    }

    // Bullet Updates
    for(let i=bullets.length-1; i>=0; i--) {
        bullets[i].x += bullets[i].vx;
        if(bullets[i].fromCEO && Math.abs(bullets[i].x - player.x) < 30 && Math.abs(bullets[i].y - player.y) < 30) {
            if(level === 6) { level6.moneyLives--; updateLives(); if(level6.moneyLives <= 0) state = 'over'; }
            else { lives--; updateLives(); if(lives <= 0) state = 'over'; }
            bullets.splice(i, 1);
        }
    }
    
    frame++;
}

// Game Loop
function tick() {
    update();
    drawScene();
    requestAnimationFrame(tick);
}

// Input Handlers
document.addEventListener('keydown', e => { keys[e.key] = true; if(state==='rtPresents') handleRTPresentsInteraction(); });
document.addEventListener('keyup', e => { keys[e.key] = false; });

tick(); // Start Engine
</script>
</body>
</html>

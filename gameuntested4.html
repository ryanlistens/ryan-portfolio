<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PipeTech - Global Leader in Pipe Dreams</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 100%;
            max-height: 100%;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            background: #2a2a2a;
            touch-action: none;
        }
        #controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            pointer-events: none;
            z-index: 1000;
        }
        #dpad {
            display: grid;
            grid-template: repeat(3, 70px) / repeat(3, 70px);
            gap: 10px;
            pointer-events: all;
        }
        .control-btn {
            background: rgba(60, 60, 60, 0.8);
            border: 3px solid rgba(100, 100, 100, 0.6);
            border-radius: 12px;
            color: #fff;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.1s;
            touch-action: none;
        }
        .control-btn:active {
            background: rgba(100, 100, 100, 0.9);
            transform: scale(0.95);
        }
        #jumpBtn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(200, 80, 60, 0.8);
            border: 4px solid rgba(255, 100, 80, 0.6);
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            pointer-events: all;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.1s;
            touch-action: none;
        }
        #jumpBtn:active {
            background: rgba(255, 100, 80, 0.9);
            transform: scale(0.95);
        }
        #hud {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            padding: 15px 25px;
            background: rgba(40, 40, 40, 0.9);
            border: 2px solid rgba(100, 100, 100, 0.5);
            border-radius: 10px;
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            z-index: 999;
            backdrop-filter: blur(10px);
        }
        .hud-item { display: flex; align-items: center; gap: 10px; }
        .heart { color: #e74c3c; }
        .coin { color: #f39c12; }
        @media (max-width: 768px) {
            #dpad {
                grid-template: repeat(3, 60px) / repeat(3, 60px);
                gap: 8px;
            }
            .control-btn { font-size: 24px; }
            #jumpBtn { width: 100px; height: 100px; font-size: 20px; }
            #hud { font-size: 16px; padding: 12px 20px; }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="hud" style="display: none;">
            <div class="hud-item"><span class="heart">‚ù§Ô∏è</span><span id="lives">3</span></div>
            <div class="hud-item"><span>Level</span><span id="levelDisplay">1</span></div>
            <div class="hud-item"><span class="coin">ü™ô</span><span id="money">0</span></div>
        </div>
        <div id="controls" style="display: none;">
            <div id="dpad">
                <div></div>
                <div class="control-btn" id="upBtn">‚ñ≤</div>
                <div></div>
                <div class="control-btn" id="leftBtn">‚óÑ</div>
                <div></div>
                <div class="control-btn" id="rightBtn">‚ñ∫</div>
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div id="jumpBtn">JUMP</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Set canvas to full screen
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Game state
        let state = 'title'; // title, playing, gameover, win
        let frame = 0;
        let level = 1;
        let lives = 3;
        let money = 0;

        // Player
        const player = {
            x: 100,
            y: 0,
            width: 40,
            height: 60,
            vx: 0,
            vy: 0,
            speed: 5,
            jumpPower: 15,
            grounded: false,
            color: '#5B9BD5' // Blue jacket color
        };

        // Platforms
        let platforms = [];

        // Coins
        let coins = [];

        // Enemies (workers)
        let enemies = [];

        // Pipes (overhead decoration and platforms)
        let pipes = [];

        // Particle effects
        let particles = [];

        // Control state
        const keys = {};
        const touchControls = {
            left: false,
            right: false,
            jump: false
        };

        // Initialize Level 1
        function initLevel1() {
            const groundY = canvas.height - 80;

            platforms = [
                // Ground
                { x: 0, y: groundY, width: canvas.width, height: 80, type: 'concrete' },
                // Platforms
                { x: 200, y: groundY - 150, width: 150, height: 20, type: 'metal' },
                { x: 450, y: groundY - 250, width: 150, height: 20, type: 'metal' },
                { x: 700, y: groundY - 180, width: 150, height: 20, type: 'metal' },
                { x: 950, y: groundY - 280, width: 200, height: 20, type: 'metal' }
            ];

            coins = [
                { x: 250, y: groundY - 200, collected: false },
                { x: 500, y: groundY - 300, collected: false },
                { x: 750, y: groundY - 230, collected: false },
                { x: 1050, y: groundY - 330, collected: false }
            ];

            enemies = [
                { x: 400, y: groundY - 60, width: 40, height: 60, color: '#C0504D', dir: 1, speed: 2 },
                { x: 800, y: groundY - 60, width: 40, height: 60, color: '#9BBB59', dir: -1, speed: 2 }
            ];

            pipes = [
                { x: 100, y: 50, width: 400, height: 30, color: '#C0504D', angle: 5 },
                { x: 350, y: 80, width: 400, height: 30, color: '#9BBB59', angle: -3 },
                { x: 600, y: 60, width: 400, height: 30, color: '#5B9BD5', angle: 4 },
                { x: 850, y: 90, width: 400, height: 30, color: '#F39C12', angle: -2 }
            ];

            player.x = 100;
            player.y = groundY - 100;
            player.vx = 0;
            player.vy = 0;
        }

        // Draw industrial background
        function drawBackground() {
            // Concrete wall background with gritty texture
            ctx.fillStyle = '#3a3a3a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Add concrete texture
            ctx.fillStyle = 'rgba(50, 50, 50, 0.3)';
            for (let i = 0; i < 100; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 3;
                ctx.fillRect(x, y, size, size);
            }

            // Wall panels
            ctx.strokeStyle = 'rgba(60, 60, 60, 0.5)';
            ctx.lineWidth = 2;
            for (let x = 0; x < canvas.width; x += 200) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }

            // Draw pipes overhead
            pipes.forEach(pipe => {
                ctx.save();
                ctx.translate(pipe.x + pipe.width / 2, pipe.y + pipe.height / 2);
                ctx.rotate((pipe.angle * Math.PI) / 180);

                // Pipe body with metallic sheen
                const gradient = ctx.createLinearGradient(0, -pipe.height / 2, 0, pipe.height / 2);
                gradient.addColorStop(0, lightenColor(pipe.color, 40));
                gradient.addColorStop(0.5, pipe.color);
                gradient.addColorStop(1, darkenColor(pipe.color, 30));

                ctx.fillStyle = gradient;
                ctx.fillRect(-pipe.width / 2, -pipe.height / 2, pipe.width, pipe.height);

                // Pipe segments
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.lineWidth = 2;
                for (let i = 0; i < pipe.width; i += 40) {
                    ctx.beginPath();
                    ctx.moveTo(-pipe.width / 2 + i, -pipe.height / 2);
                    ctx.lineTo(-pipe.width / 2 + i, pipe.height / 2);
                    ctx.stroke();
                }

                // Highlights
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(-pipe.width / 2, -pipe.height / 2 + 5);
                ctx.lineTo(pipe.width / 2, -pipe.height / 2 + 5);
                ctx.stroke();

                ctx.restore();
            });
        }

        // Draw title screen
        function drawTitleScreen() {
            // Industrial background
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Concrete texture
            ctx.fillStyle = 'rgba(50, 50, 50, 0.4)';
            for (let i = 0; i < 200; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 4;
                ctx.fillRect(x, y, size, size);
            }

            // PipeTech sign background
            const signX = canvas.width / 2 - 300;
            const signY = 80;
            const signWidth = 600;
            const signHeight = 150;

            // Sign background (weathered concrete)
            ctx.fillStyle = '#4a4a4a';
            ctx.fillRect(signX, signY, signWidth, signHeight);

            // Weathering and stains
            ctx.fillStyle = 'rgba(30, 30, 30, 0.3)';
            ctx.fillRect(signX + 50, signY + 10, 200, 130);
            ctx.fillRect(signX + 400, signY + 20, 150, 100);

            // Border
            ctx.strokeStyle = '#2a2a2a';
            ctx.lineWidth = 4;
            ctx.strokeRect(signX, signY, signWidth, signHeight);

            // "PipeTech" title
            ctx.fillStyle = '#2a2a2a';
            ctx.font = 'bold 72px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('PipeTech', canvas.width / 2, signY + 85);

            // Colored stripe (like in reference)
            const stripeY = signY + 100;
            const stripeHeight = 8;
            const stripeSegmentWidth = signWidth / 4;

            ctx.fillStyle = '#C0504D'; // Red
            ctx.fillRect(signX, stripeY, stripeSegmentWidth, stripeHeight);

            ctx.fillStyle = '#9BBB59'; // Green
            ctx.fillRect(signX + stripeSegmentWidth, stripeY, stripeSegmentWidth, stripeHeight);

            ctx.fillStyle = '#5B9BD5'; // Blue
            ctx.fillRect(signX + stripeSegmentWidth * 2, stripeY, stripeSegmentWidth, stripeHeight);

            ctx.fillStyle = '#F39C12'; // Yellow/Orange
            ctx.fillRect(signX + stripeSegmentWidth * 3, stripeY, stripeSegmentWidth, stripeHeight);

            // Subtitle
            ctx.fillStyle = '#3a3a3a';
            ctx.font = 'bold 32px Arial';
            ctx.fillText('Global Leader in Pipe Dreams', canvas.width / 2, signY + 145);

            // Control panels at bottom
            drawControlPanel(100, canvas.height - 200, 150, 120, '#C0504D');
            drawControlPanel(canvas.width - 250, canvas.height - 200, 150, 120, '#9BBB59');

            // Pipes in background
            drawDecorativePipes();

            // Sparks effect
            if (frame % 20 < 3) {
                drawSparks(canvas.width - 200, canvas.height - 100);
            }

            // Start prompt
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            const alpha = Math.sin(frame * 0.1) * 0.5 + 0.5;
            ctx.globalAlpha = alpha;
            ctx.fillText('TAP OR PRESS ANY KEY TO START', canvas.width / 2, canvas.height - 100);
            ctx.globalAlpha = 1;
        }

        // Draw control panel
        function drawControlPanel(x, y, width, height, accentColor) {
            // Panel body
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(x, y, width, height);
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, width, height);

            // Buttons and lights
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 2; j++) {
                    const btnX = x + 20 + i * 40;
                    const btnY = y + 20 + j * 40;

                    ctx.fillStyle = Math.random() > 0.5 ? accentColor : '#4a4a4a';
                    ctx.beginPath();
                    ctx.arc(btnX, btnY, 8, 0, Math.PI * 2);
                    ctx.fill();

                    if (Math.random() > 0.7) {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                        ctx.beginPath();
                        ctx.arc(btnX - 2, btnY - 2, 3, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }

            // Display screen
            ctx.fillStyle = '#1a3a1a';
            ctx.fillRect(x + 10, y + height - 40, width - 20, 30);
            ctx.strokeStyle = accentColor;
            ctx.lineWidth = 2;
            ctx.strokeRect(x + 10, y + height - 40, width - 20, 30);
        }

        // Draw decorative pipes
        function drawDecorativePipes() {
            const colors = ['#C0504D', '#9BBB59', '#5B9BD5', '#F39C12'];
            for (let i = 0; i < 4; i++) {
                const y = 300 + i * 40;
                const gradient = ctx.createLinearGradient(0, y, 0, y + 25);
                gradient.addColorStop(0, lightenColor(colors[i], 40));
                gradient.addColorStop(0.5, colors[i]);
                gradient.addColorStop(1, darkenColor(colors[i], 30));

                ctx.fillStyle = gradient;
                ctx.fillRect(0, y, canvas.width, 25);

                // Segment lines
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.lineWidth = 2;
                for (let x = 0; x < canvas.width; x += 50) {
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x, y + 25);
                    ctx.stroke();
                }
            }
        }

        // Draw sparks
        function drawSparks(x, y) {
            for (let i = 0; i < 10; i++) {
                ctx.fillStyle = '#FFA500';
                const sparkX = x + (Math.random() - 0.5) * 30;
                const sparkY = y + (Math.random() - 0.5) * 30;
                const size = Math.random() * 3 + 1;
                ctx.fillRect(sparkX, sparkY, size, size);
            }
        }

        // Draw platforms
        function drawPlatforms() {
            platforms.forEach(platform => {
                if (platform.type === 'concrete') {
                    // Concrete floor
                    ctx.fillStyle = '#4a4a4a';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);

                    // Texture
                    ctx.fillStyle = 'rgba(60, 60, 60, 0.5)';
                    for (let i = 0; i < platform.width; i += 10) {
                        ctx.fillRect(platform.x + i, platform.y, 2, platform.height);
                    }
                } else {
                    // Metal platform
                    const gradient = ctx.createLinearGradient(0, platform.y, 0, platform.y + platform.height);
                    gradient.addColorStop(0, '#6a6a6a');
                    gradient.addColorStop(0.5, '#4a4a4a');
                    gradient.addColorStop(1, '#3a3a3a');

                    ctx.fillStyle = gradient;
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);

                    ctx.strokeStyle = '#2a2a2a';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
                }
            });
        }

        // Draw player (protagonist character)
        function drawPlayer() {
            // Body (blue jacket)
            const bodyGradient = ctx.createLinearGradient(player.x, player.y + 20, player.x, player.y + 50);
            bodyGradient.addColorStop(0, lightenColor(player.color, 20));
            bodyGradient.addColorStop(1, darkenColor(player.color, 20));

            ctx.fillStyle = bodyGradient;
            ctx.fillRect(player.x + 8, player.y + 20, player.width - 16, player.height - 30);

            // Head (skin tone)
            ctx.fillStyle = '#D4A574';
            ctx.beginPath();
            ctx.arc(player.x + player.width / 2, player.y + 12, 10, 0, Math.PI * 2);
            ctx.fill();

            // Hair
            ctx.fillStyle = '#3a2a1a';
            ctx.fillRect(player.x + player.width / 2 - 8, player.y + 3, 16, 10);

            // Legs (dark pants)
            ctx.fillStyle = '#2a2a3a';
            ctx.fillRect(player.x + 10, player.y + player.height - 12, 8, 12);
            ctx.fillRect(player.x + 22, player.y + player.height - 12, 8, 12);

            // Arms
            ctx.strokeStyle = player.color;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(player.x + 8, player.y + 25);
            ctx.lineTo(player.x + 3, player.y + 35);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(player.x + player.width - 8, player.y + 25);
            ctx.lineTo(player.x + player.width - 3, player.y + 35);
            ctx.stroke();

            // Sunglasses
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(player.x + player.width / 2 - 7, player.y + 10, 14, 4);
        }

        // Draw enemies (workers)
        function drawEnemies() {
            enemies.forEach(enemy => {
                // Body (colored jumpsuit)
                const bodyGradient = ctx.createLinearGradient(enemy.x, enemy.y, enemy.x, enemy.y + enemy.height);
                bodyGradient.addColorStop(0, lightenColor(enemy.color, 20));
                bodyGradient.addColorStop(1, darkenColor(enemy.color, 20));

                ctx.fillStyle = bodyGradient;
                ctx.fillRect(enemy.x + 8, enemy.y + 15, enemy.width - 16, enemy.height - 20);

                // Head (skin tone)
                ctx.fillStyle = '#D4A574';
                ctx.beginPath();
                ctx.arc(enemy.x + enemy.width / 2, enemy.y + 10, 8, 0, Math.PI * 2);
                ctx.fill();

                // Hard hat
                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x + enemy.width / 2, enemy.y + 5, 10, Math.PI, 2 * Math.PI);
                ctx.fill();
                ctx.fillRect(enemy.x + enemy.width / 2 - 12, enemy.y + 5, 24, 3);

                // Legs
                ctx.fillStyle = enemy.color;
                ctx.fillRect(enemy.x + 10, enemy.y + enemy.height - 8, 6, 8);
                ctx.fillRect(enemy.x + 24, enemy.y + enemy.height - 8, 6, 8);
            });
        }

        // Draw coins
        function drawCoins() {
            coins.forEach(coin => {
                if (!coin.collected) {
                    const wobble = Math.sin(frame * 0.1 + coin.x) * 3;

                    ctx.fillStyle = '#F39C12';
                    ctx.beginPath();
                    ctx.arc(coin.x, coin.y + wobble, 12, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#FFA500';
                    ctx.beginPath();
                    ctx.arc(coin.x - 3, coin.y + wobble - 3, 5, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.strokeStyle = '#D68910';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(coin.x, coin.y + wobble, 12, 0, Math.PI * 2);
                    ctx.stroke();
                }
            });
        }

        // Helper functions for colors
        function lightenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.min(255, (num >> 16) + amt);
            const G = Math.min(255, (num >> 8 & 0x00FF) + amt);
            const B = Math.min(255, (num & 0x0000FF) + amt);
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        function darkenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, (num >> 16) - amt);
            const G = Math.max(0, (num >> 8 & 0x00FF) - amt);
            const B = Math.max(0, (num & 0x0000FF) - amt);
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        // Physics
        function updatePlayer() {
            // Gravity
            player.vy += 0.8;

            // Movement
            if (keys['ArrowLeft'] || keys['a'] || keys['A'] || touchControls.left) {
                player.vx = -player.speed;
            } else if (keys['ArrowRight'] || keys['d'] || keys['D'] || touchControls.right) {
                player.vx = player.speed;
            } else {
                player.vx = 0;
            }

            // Jump
            if ((keys['ArrowUp'] || keys['w'] || keys['W'] || keys[' '] || touchControls.jump) && player.grounded) {
                player.vy = -player.jumpPower;
                player.grounded = false;
            }

            // Apply velocity
            player.x += player.vx;
            player.y += player.vy;

            // Reset grounded
            player.grounded = false;

            // Platform collision
            platforms.forEach(platform => {
                if (player.x + player.width > platform.x &&
                    player.x < platform.x + platform.width &&
                    player.y + player.height > platform.y &&
                    player.y + player.height < platform.y + platform.height + player.vy) {

                    player.y = platform.y - player.height;
                    player.vy = 0;
                    player.grounded = true;
                }
            });

            // Screen bounds
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

            // Fall off screen
            if (player.y > canvas.height) {
                lives--;
                if (lives <= 0) {
                    state = 'gameover';
                } else {
                    initLevel1();
                }
            }
        }

        // Update enemies
        function updateEnemies() {
            enemies.forEach(enemy => {
                enemy.x += enemy.speed * enemy.dir;

                // Bounce off edges
                if (enemy.x < 0 || enemy.x + enemy.width > canvas.width) {
                    enemy.dir *= -1;
                }

                // Player collision
                if (player.x + player.width > enemy.x &&
                    player.x < enemy.x + enemy.width &&
                    player.y + player.height > enemy.y &&
                    player.y < enemy.y + enemy.height) {

                    lives--;
                    if (lives <= 0) {
                        state = 'gameover';
                    } else {
                        initLevel1();
                    }
                }
            });
        }

        // Update coins
        function updateCoins() {
            coins.forEach(coin => {
                if (!coin.collected) {
                    const dist = Math.sqrt(Math.pow(player.x + player.width / 2 - coin.x, 2) +
                                         Math.pow(player.y + player.height / 2 - coin.y, 2));
                    if (dist < 25) {
                        coin.collected = true;
                        money += 10;
                    }
                }
            });
        }

        // Draw game over screen
        function drawGameOver() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#C0504D';
            ctx.font = 'bold 72px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('GAME OVER', canvas.width / 2, canvas.height / 2 - 50);

            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 36px Arial';
            ctx.fillText('Score: ' + money, canvas.width / 2, canvas.height / 2 + 20);

            const alpha = Math.sin(frame * 0.1) * 0.5 + 0.5;
            ctx.globalAlpha = alpha;
            ctx.fillText('TAP OR PRESS ANY KEY TO RESTART', canvas.width / 2, canvas.height / 2 + 100);
            ctx.globalAlpha = 1;
        }

        // Game loop
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (state === 'title') {
                drawTitleScreen();
            } else if (state === 'playing') {
                drawBackground();
                drawPlatforms();
                drawCoins();
                drawEnemies();
                drawPlayer();

                updatePlayer();
                updateEnemies();
                updateCoins();

                // Update HUD
                document.getElementById('lives').textContent = lives;
                document.getElementById('levelDisplay').textContent = level;
                document.getElementById('money').textContent = money;
            } else if (state === 'gameover') {
                drawGameOver();
            }

            frame++;
            requestAnimationFrame(gameLoop);
        }

        // Input handling
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;

            if (state === 'title') {
                state = 'playing';
                initLevel1();
                document.getElementById('hud').style.display = 'flex';
                document.getElementById('controls').style.display = 'flex';
            } else if (state === 'gameover') {
                state = 'playing';
                lives = 3;
                money = 0;
                level = 1;
                initLevel1();
            }
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Touch controls
        document.getElementById('leftBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchControls.left = true;
        });
        document.getElementById('leftBtn').addEventListener('touchend', (e) => {
            e.preventDefault();
            touchControls.left = false;
        });

        document.getElementById('rightBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchControls.right = true;
        });
        document.getElementById('rightBtn').addEventListener('touchend', (e) => {
            e.preventDefault();
            touchControls.right = false;
        });

        document.getElementById('jumpBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchControls.jump = true;
        });
        document.getElementById('jumpBtn').addEventListener('touchend', (e) => {
            e.preventDefault();
            touchControls.jump = false;
        });

        // Mouse controls for desktop testing
        document.getElementById('leftBtn').addEventListener('mousedown', () => touchControls.left = true);
        document.getElementById('leftBtn').addEventListener('mouseup', () => touchControls.left = false);
        document.getElementById('rightBtn').addEventListener('mousedown', () => touchControls.right = true);
        document.getElementById('rightBtn').addEventListener('mouseup', () => touchControls.right = false);
        document.getElementById('jumpBtn').addEventListener('mousedown', () => touchControls.jump = true);
        document.getElementById('jumpBtn').addEventListener('mouseup', () => touchControls.jump = false);

        // Canvas click/touch for starting game
        canvas.addEventListener('click', () => {
            if (state === 'title') {
                state = 'playing';
                initLevel1();
                document.getElementById('hud').style.display = 'flex';
                document.getElementById('controls').style.display = 'flex';
            } else if (state === 'gameover') {
                state = 'playing';
                lives = 3;
                money = 0;
                level = 1;
                initLevel1();
            }
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (state === 'title') {
                state = 'playing';
                initLevel1();
                document.getElementById('hud').style.display = 'flex';
                document.getElementById('controls').style.display = 'flex';
            } else if (state === 'gameover') {
                state = 'playing';
                lives = 3;
                money = 0;
                level = 1;
                initLevel1();
            }
        });

        // Start game loop
        gameLoop();
    </script>
</body>
</html>

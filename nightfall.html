<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>NIGHTFALL - A Collage Noir</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Special+Elite&family=Playfair+Display:wght@700;900&display=swap');
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        html,body{width:100%;height:100%;overflow:hidden;background:#080706;font-family:'Special Elite',monospace}
        #game{position:fixed;top:0;left:0;width:100%;height:100%;overflow:hidden;cursor:crosshair;touch-action:none}

        /* === GILLIAM ANIMATIONS === */
        @keyframes gi{0%,100%{transform:rotate(0) translateY(0)}12%{transform:rotate(.7deg) translateY(-2px)}37%{transform:rotate(-.5deg) translateY(1px)}62%{transform:rotate(-.8deg) translateY(-1px)}84%{transform:rotate(.4deg) translateY(0)}}
        @keyframes gw{0%,100%{transform:rotate(-2deg) translateY(0)}25%{transform:rotate(3deg) translateY(-6px)}50%{transform:rotate(-2deg) translateY(0)}75%{transform:rotate(3deg) translateY(-6px)}}
        @keyframes gt{0%,100%{transform:rotate(0) scale(1)}12%{transform:rotate(-2deg) scale(1.03)}28%{transform:rotate(2deg) scale(.97)}44%{transform:rotate(-1.5deg) scale(1.02)}62%{transform:rotate(1.5deg) scale(.98)}78%{transform:rotate(-.5deg) scale(1.01)}}
        @keyframes gs{0%,100%{transform:rotate(-.3deg)}50%{transform:rotate(.3deg)}}
        @keyframes nb{0%,18%,22%,25%,53%,57%,100%{opacity:1}20%,24%,55%{opacity:.3}}
        @keyframes smk{0%{transform:translateY(0) scale(1) rotate(0);opacity:.5}40%{transform:translateY(-30px) scale(1.4) rotate(15deg);opacity:.25}100%{transform:translateY(-70px) scale(2.2) rotate(35deg);opacity:0}}
        @keyframes fl{0%,100%{opacity:.7}50%{opacity:1}}
        @keyframes dr{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-3px) rotate(.4deg)}}
        @keyframes pu{0%,100%{opacity:.3}50%{opacity:1}}
        @keyframes se{0%{opacity:0;transform:scale(1.04) rotate(-.4deg)}100%{opacity:1;transform:scale(1) rotate(0)}}
        @keyframes fadeIn{0%{opacity:0}100%{opacity:1}}

        /* === CUTOUT SYSTEM === */
        .cut{position:absolute;overflow:hidden}
        .cut img{width:100%;height:100%;object-fit:cover;display:block}
        .cut.torn{filter:grayscale(55%) contrast(1.3) sepia(25%) brightness(.85);box-shadow:3px 4px 0 rgba(0,0,0,.7),-1px -1px 0 rgba(220,210,190,.08)}
        .cut.framed{filter:grayscale(50%) contrast(1.25) sepia(30%) brightness(.8);border:5px solid #e8e0d0;box-shadow:4px 5px 15px rgba(0,0,0,.7),inset 0 0 20px rgba(0,0,0,.3)}
        .cut.rough{filter:grayscale(60%) contrast(1.35) sepia(20%) brightness(.75);box-shadow:2px 3px 1px rgba(0,0,0,.6),-1px -2px 0 rgba(0,0,0,.3)}
        .cut.pasted{filter:grayscale(40%) contrast(1.2) sepia(35%);box-shadow:2px 3px 8px rgba(0,0,0,.5);border:2px solid rgba(200,190,170,.15)}

        /* === SCENES === */
        .scene{position:absolute;width:100%;height:100%;display:none;animation:se 1s ease-out}
        .scene.active{display:block}

        /* === STREET === */
        #sc-street{background:linear-gradient(170deg,#050608,#0a0c12 35%,#0e1018)}
        .photo-bg{position:absolute;top:0;left:-5%;width:110%;height:78%;overflow:hidden;opacity:.3}
        .photo-bg img{width:100%;height:100%;object-fit:cover;object-position:center 30%;filter:grayscale(70%) contrast(1.5) brightness(.5) sepia(15%)}
        .bg-fade{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,rgba(5,6,8,.2) 0%,transparent 15%,rgba(5,6,8,.1) 40%,rgba(5,6,8,.5) 60%,rgba(5,6,8,.92) 78%,#080a10 88%);pointer-events:none}
        .bg-side{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to right,rgba(5,6,8,.6) 0%,transparent 15%,transparent 85%,rgba(5,6,8,.6) 100%);pointer-events:none}
        .moon{position:absolute;top:4%;right:14%;width:65px;height:65px;border-radius:50%;background:radial-gradient(circle at 35% 30%,#fff8e0,#f0e8c8 30%,#d8c8a0 55%,#a09070 75%,transparent);box-shadow:0 0 40px rgba(255,250,200,.25),0 0 80px rgba(255,250,200,.1);animation:dr 12s ease-in-out infinite}
        .bldg-layer{position:absolute;bottom:20%;left:0;width:100%;height:60%;pointer-events:none}
        .bs{position:absolute;bottom:0;background:#06060a;animation:gs 10s ease-in-out infinite}
        .b1{left:0;width:18%;height:80%;clip-path:polygon(0 100%,0 25%,5% 25%,5% 12%,15% 12%,15% 0,30% 0,30% 8%,45% 8%,45% 18%,55% 18%,55% 0,68% 0,68% 15%,80% 15%,80% 8%,100% 8%,100% 100%)}
        .b2{left:17%;width:22%;height:72%;clip-path:polygon(0 100%,0 30%,8% 30%,8% 10%,20% 10%,20% 0,40% 0,40% 5%,55% 5%,55% 15%,65% 15%,65% 5%,80% 5%,80% 20%,100% 20%,100% 100%);animation-delay:-3s}
        .b3{left:38%;width:25%;height:82%;clip-path:polygon(0 100%,0 22%,12% 22%,12% 8%,25% 8%,25% 0,42% 0,42% 3%,55% 3%,55% 12%,70% 12%,70% 0,85% 0,85% 18%,100% 18%,100% 100%);animation-delay:-5s}
        .b4{left:62%;width:20%;height:68%;clip-path:polygon(0 100%,0 25%,15% 25%,15% 8%,35% 8%,35% 0,55% 0,55% 12%,70% 12%,70% 20%,100% 20%,100% 100%);animation-delay:-7s}
        .b5{left:80%;width:21%;height:75%;clip-path:polygon(0 100%,0 18%,10% 18%,10% 5%,30% 5%,30% 0,50% 0,50% 8%,65% 8%,65% 0,80% 0,80% 12%,100% 12%,100% 100%);animation-delay:-2s}
        .w{position:absolute;background:rgba(255,215,130,.65);box-shadow:0 0 8px rgba(255,200,100,.3);animation:fl 4s ease-in-out infinite}
        .neon{position:absolute;font-weight:bold;z-index:10;cursor:pointer;user-select:none}
        .nr{font-family:sans-serif;font-size:clamp(20px,4.5vw,32px);color:#ff2020;text-shadow:0 0 7px #ff2020,0 0 15px #ff2020,0 0 35px #f00,0 0 60px #c00;animation:nb 3s ease-in-out infinite}
        .nbl{font-family:sans-serif;font-size:clamp(14px,3vw,24px);color:#4499ff;text-shadow:0 0 6px #4499ff,0 0 14px #4499ff,0 0 30px #26d;animation:nb 3.5s ease-in-out infinite;animation-delay:-1.2s}
        .na{font-family:cursive;font-size:clamp(12px,2.5vw,20px);color:#ffaa30;text-shadow:0 0 6px #ffaa30,0 0 12px #f81;animation:nb 4s ease-in-out infinite;animation-delay:-2.5s}
        .ng{font-family:sans-serif;font-size:clamp(8px,1.8vw,14px);color:#44dd66;text-shadow:0 0 5px #44dd66,0 0 12px #2a4;animation:nb 3.2s ease-in-out infinite;animation-delay:-.8s}
        .sp{font-family:'Special Elite',monospace;font-size:clamp(6px,1.4vw,10px);color:#b0a080;letter-spacing:3px;text-shadow:0 0 4px rgba(180,160,120,.3)}
        .nr-ref{position:absolute;bottom:2%;filter:blur(3px);opacity:.4;animation:nb 3s ease-in-out infinite;pointer-events:none}
        .st-ground{position:absolute;bottom:0;left:0;width:100%;height:22%;background:linear-gradient(to bottom,#141418,#0e0e12 30%,#0a0a0e)}
        .sidewalk{position:absolute;top:0;left:0;width:100%;height:18%;background:linear-gradient(to bottom,#202028,#1a1a20);border-top:2px solid #2a2a32}
        .lamp{position:absolute;bottom:20%;z-index:8;animation:gi 12s ease-in-out infinite}
        .lp{width:4px;height:140px;background:linear-gradient(to right,#0a0a0a,#1a1a1a,#0a0a0a);margin:0 auto}
        .lh{width:28px;height:18px;background:#0e0e0e;border-radius:3px 3px 0 0;margin:0 auto;position:relative}
        .lh::after{content:'';position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:14px;height:6px;background:rgba(255,240,200,.9);border-radius:50%;box-shadow:0 0 8px rgba(255,240,200,.6)}
        .lpool{position:absolute;top:-60px;left:50%;transform:translateX(-50%);width:200px;height:220px;background:radial-gradient(ellipse at top,rgba(255,240,200,.12),rgba(255,240,200,.04) 35%,transparent 65%);pointer-events:none}
        .car-cut{position:absolute;bottom:3%;left:52%;width:clamp(130px,26vw,220px);height:clamp(55px,11vw,90px);z-index:6;cursor:pointer;animation:gi 7s ease-in-out infinite;animation-delay:-2s}
        .car-cut img{width:100%;height:100%;object-fit:contain;filter:brightness(.35) contrast(1.4) grayscale(65%) sepia(15%);transition:filter .3s}
        .car-cut:hover img{filter:brightness(.5) contrast(1.3) grayscale(45%) sepia(15%)}

        /* === CHARACTERS === */
        .ch{position:absolute;z-index:50;transform-origin:bottom center;cursor:pointer}
        .ch.idle{animation:gi 4s ease-in-out infinite}
        .ch.walking{animation:gw .35s ease-in-out infinite}
        .ch.talking{animation:gt .25s ease-in-out infinite}
        .ch .pb{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden}
        .ch .pb img{width:100%;height:100%;object-fit:cover;display:block}
        .ch .cshadow{position:absolute;bottom:-5px;left:5%;width:90%;height:10px;background:rgba(0,0,0,.6);border-radius:50%;filter:blur(4px)}
        #player{width:clamp(48px,8vw,62px);height:clamp(130px,22vw,170px);z-index:100}
        #player .pb img{object-position:center 10%;filter:brightness(.55) contrast(1.5) grayscale(50%) sepia(20%)}
        .viv{width:clamp(40px,7vw,52px);height:clamp(120px,20vw,155px)}
        .viv .pb img{object-position:center 8%;filter:brightness(.5) contrast(1.4) grayscale(45%) sepia(25%)}
        .csmoke{position:absolute;top:28%;right:-15%;width:10px;height:10px;background:rgba(180,175,165,.4);border-radius:50%;animation:smk 2.8s ease-out infinite}
        .csmoke:nth-child(2){animation-delay:-.9s;width:8px;height:8px}
        .csmoke:nth-child(3){animation-delay:-1.8s;width:6px;height:6px}
        .ipip{position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:14px;color:#c4a35a;opacity:0;transition:opacity .3s;animation:dr 1.5s ease-in-out infinite;pointer-events:none}
        .ch:hover .ipip,.car-cut:hover .ipip,.clue:hover .ipip,.hotspot:hover .ipip{opacity:1}

        /* === CLUES === */
        .clue{position:absolute;cursor:pointer;z-index:30;animation:dr 3s ease-in-out infinite;transition:transform .2s,filter .2s}
        .clue:hover{transform:scale(1.12);filter:brightness(1.4) drop-shadow(0 0 10px rgba(255,200,100,.3))}
        .cl-paper{bottom:7%;left:20%;width:42px;height:52px;background:#ddd8c8;transform:rotate(-3deg);box-shadow:2px 3px 8px rgba(0,0,0,.6);padding:4px;overflow:hidden}
        .pt{font-family:'Playfair Display',serif;font-size:5px;font-weight:900;color:#1a1a1a;text-align:center;border-bottom:1px solid #333;padding-bottom:2px;margin-bottom:2px}
        .ph{font-family:serif;font-size:4px;font-weight:bold;color:#2a2a2a;line-height:1.3}
        .pp{font-size:3px;color:#555;line-height:1.2;margin-top:2px}
        .cl-match{bottom:5%;left:70%;width:24px;height:30px;background:linear-gradient(to bottom,#8b0000,#5a0000);border-radius:2px 2px 0 0;box-shadow:1px 2px 5px rgba(0,0,0,.7);animation-delay:-1.5s;display:flex;align-items:center;justify-content:center}
        .mt{font-size:3px;color:#d4a030;text-align:center;line-height:1.2;font-family:sans-serif;font-weight:bold}
        .door-zone{position:absolute;cursor:pointer;z-index:20;transition:box-shadow .3s}
        .door-zone::after{content:attr(data-label);position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:8px;color:#8a7a5a;letter-spacing:2px;opacity:0;transition:opacity .3s;white-space:nowrap;font-family:'Special Elite',monospace}
        .door-zone:hover::after{opacity:1}
        .door-zone:hover{box-shadow:0 0 30px rgba(255,200,100,.25)}

        /* === BAR INTERIOR === */
        #sc-bar{background:linear-gradient(to bottom,#0c0814,#06040a)}
        .bar-wall{position:absolute;top:0;left:0;width:100%;height:72%;background:linear-gradient(to bottom,#14101c,#0a0810)}
        .bar-mirror{position:absolute;top:6%;left:12%;width:76%;height:48%;background:linear-gradient(135deg,rgba(35,30,45,.6),rgba(18,15,25,.8));border:5px solid #2a2222}
        .bar-shelf{position:absolute;background:#1a1515;border:2px solid #2a2020}
        .bottle{position:absolute;border-radius:3px 3px 0 0}
        .bar-counter{position:absolute;bottom:22%;left:3%;width:94%;height:12%;background:linear-gradient(to bottom,#3a2518,#2a1810);border-top:6px solid #4a3020}
        .stool{position:absolute;bottom:12%}
        .stool-t{width:28px;height:8px;background:#2a1a12;border-radius:3px}
        .stool-l{width:4px;height:45px;background:#1a1a1a;margin:0 auto}
        .bar-floor{position:absolute;bottom:0;left:0;width:100%;height:15%;background:linear-gradient(to bottom,#12100c,#0a0808)}
        .beer-sign{position:absolute;top:8%;right:10%;font-family:cursive;font-size:16px;color:#ffaa33;text-shadow:0 0 8px #ffaa33,0 0 16px #f81;animation:nb 4s ease-in-out infinite;transform:rotate(-3deg)}
        .bart{width:clamp(45px,7vw,55px);height:clamp(110px,17vw,135px)}
        .bart .pb{background:linear-gradient(to bottom,#1a1818,#0e0e0e);clip-path:polygon(20% 0%,80% 0%,85% 15%,90% 50%,85% 100%,15% 100%,10% 50%,15% 15%)}
        .bart-face{position:absolute;top:5%;left:50%;transform:translateX(-50%);width:50%;height:16%;background:linear-gradient(to bottom,#c0a080,#a88868);border-radius:4px 4px 6px 6px;z-index:2}
        .bart-apron{position:absolute;bottom:0;left:22%;width:56%;height:45%;background:#d8d0c8}
        .bart-towel{position:absolute;top:30%;right:-10%;width:30%;height:5px;background:#d0c8c0;transform:rotate(-15deg)}

        /* === PI OFFICE === */
        #sc-office{background:#12100d}
        .off-wall{position:absolute;top:0;left:0;width:100%;height:72%;background:linear-gradient(to bottom,#28221a,#1e1810)}
        .off-win{position:absolute;top:8%;right:12%;width:clamp(140px,25vw,200px);height:clamp(110px,20vw,160px);background:linear-gradient(to bottom,#1a2535,#0e1520);border:5px solid #2a2015}
        .blinds{position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent 0px,transparent 8px,rgba(255,240,200,.06) 8px,rgba(255,240,200,.06) 11px)}
        .light-rays{position:absolute;top:8%;right:5%;width:280px;height:350px;background:repeating-linear-gradient(-25deg,transparent 0px,transparent 14px,rgba(255,240,200,.025) 14px,rgba(255,240,200,.025) 16px);transform:skewX(-10deg);pointer-events:none}
        .typewriter-cut{position:absolute;bottom:33%;left:42%;width:clamp(60px,12vw,90px);height:clamp(45px,9vw,65px);cursor:pointer;z-index:15}
        .typewriter-cut img{width:100%;height:100%;object-fit:contain;filter:brightness(.7) contrast(1.3) grayscale(50%) sepia(20%)}
        .typewriter-cut:hover img{filter:brightness(.85) contrast(1.3) grayscale(30%) sepia(20%)}
        .off-desk{position:absolute;bottom:18%;left:20%;width:60%;height:16%;background:#3d2a18;border-top:5px solid #4a3520}
        .off-chair{position:absolute;bottom:16%;left:32%;width:55px;height:90px}
        .ch-back{width:45px;height:55px;background:#2a1a10;border-radius:4px 4px 0 0;margin:0 auto}
        .ch-seat{width:50px;height:12px;background:#2a1a10;margin:0 auto}
        .desk-lamp{position:absolute;bottom:32%;left:25%;width:45px;height:65px}
        .ls{width:35px;height:24px;background:#2a4030;border-radius:0 0 18px 18px;margin:0 auto}
        .la{width:4px;height:35px;background:linear-gradient(to right,#8a7040,#c4a860,#8a7040);margin:0 auto}
        .lcone{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);width:100px;height:70px;background:radial-gradient(ellipse at top,rgba(255,240,200,.12),transparent 70%)}
        .off-filing{position:absolute;bottom:13%;left:6%;width:45px;height:110px;background:#3a3a3a;cursor:pointer;z-index:15}
        .fdr{width:100%;height:32%;border-bottom:2px solid #2a2a2a}
        .fdr::after{content:'';display:block;width:12px;height:3px;background:#555;margin:45% auto 0}
        .off-floor{position:absolute;bottom:0;left:0;width:100%;height:16%;background:linear-gradient(to bottom,#1a1510,#12100c)}

        /* === HOTEL LOBBY === */
        #sc-hotel{background:#0e0c08}
        .hotel-wall{position:absolute;top:0;left:0;width:100%;height:72%;background:linear-gradient(to bottom,#201a12,#181410)}
        .hotel-desk{position:absolute;bottom:18%;left:25%;width:50%;height:14%;background:linear-gradient(to bottom,#3a2a18,#2a1a10);border-top:6px solid #4a3520;z-index:5}
        .hotel-keys{position:absolute;top:15%;left:20%;width:60%;height:35%;background:#1a1510;border:3px solid #2a2015}
        .key-hook{position:absolute;width:12px;height:18px;background:#8a7a50;border-radius:2px 2px 0 0;cursor:pointer}
        .key-hook::after{content:'';position:absolute;bottom:-10px;left:3px;width:6px;height:10px;background:#a09060;border-radius:0 0 1px 1px}
        .key-hook.empty::after{display:none}
        .hotel-chandelier{position:absolute;top:2%;left:50%;transform:translateX(-50%);width:80px;height:40px}
        .hc-arm{position:absolute;bottom:0;width:2px;height:30px;background:#8a7a50}
        .hc-bulb{position:absolute;bottom:-5px;width:8px;height:8px;background:rgba(255,240,200,.8);border-radius:50%;box-shadow:0 0 15px rgba(255,240,200,.3)}
        .hotel-carpet{position:absolute;bottom:0;left:0;width:100%;height:18%;background:linear-gradient(to bottom,#2a1510,#1a0c08);background-image:repeating-linear-gradient(90deg,transparent,transparent 20px,rgba(139,0,0,.05) 20px,rgba(139,0,0,.05) 40px)}
        .hotel-column{position:absolute;bottom:18%;width:20px;background:linear-gradient(to right,#1a1510,#2a2518,#1a1510)}
        .hotel-painting{position:absolute;width:clamp(50px,10vw,80px);height:clamp(40px,8vw,60px);background:#1a2530;border:4px solid #3a3020;box-shadow:2px 2px 8px rgba(0,0,0,.5)}
        .hotel-sign{position:absolute;top:5%;left:50%;transform:translateX(-50%);font-family:'Playfair Display',serif;font-size:clamp(14px,3vw,22px);color:#a09060;letter-spacing:5px;text-shadow:0 0 10px rgba(160,140,90,.3)}

        /* === HOTEL ROOM 214 (CRIME SCENE) === */
        #sc-room{background:#0c0a08}
        .room-wall{position:absolute;top:0;left:0;width:100%;height:72%;background:linear-gradient(to bottom,#1e1812,#14100c)}
        .room-bed{position:absolute;bottom:16%;left:15%;width:55%;height:28%;background:linear-gradient(to bottom,#e8e0d0,#d8d0c0);border:3px solid #8a7a5a;border-radius:4px}
        .bed-pillow{position:absolute;top:8%;left:5%;width:25%;height:35%;background:#f0e8d8;border-radius:3px;border:1px solid #c0b8a0}
        .bed-sheet{position:absolute;top:35%;left:0;width:100%;height:65%;background:linear-gradient(to bottom,#d8d0c0,#c8c0b0);border-radius:0 0 4px 4px}
        .room-window{position:absolute;top:10%;right:10%;width:clamp(100px,18vw,140px);height:clamp(100px,18vw,140px);background:#0a1018;border:4px solid #2a2015}
        .room-curtain-l{position:absolute;top:0;left:0;width:30%;height:100%;background:linear-gradient(to right,#3a1515,#2a0a0a);opacity:.8}
        .room-curtain-r{position:absolute;top:0;right:0;width:30%;height:100%;background:linear-gradient(to left,#3a1515,#2a0a0a);opacity:.8}
        .room-table{position:absolute;bottom:22%;right:12%;width:clamp(50px,10vw,70px);height:clamp(35px,7vw,50px);background:#3d2a18;border-top:4px solid #4a3520}
        .room-phone{position:absolute;top:-15px;left:10%;width:25px;height:15px;background:#1a1a1a;border-radius:2px;cursor:pointer}
        .room-floor{position:absolute;bottom:0;left:0;width:100%;height:16%;background:linear-gradient(to bottom,#1a1510,#12100c)}
        .chalk-outline{position:absolute;bottom:20%;left:30%;width:clamp(80px,16vw,120px);height:clamp(40px,8vw,60px);border:2px dashed rgba(255,255,255,.15);border-radius:50%;transform:rotate(-15deg)}
        .evidence-marker{position:absolute;width:16px;height:20px;background:#ddd830;color:#1a1a1a;font-size:8px;font-weight:bold;text-align:center;line-height:20px;cursor:pointer;z-index:15}
        .room-tape{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:2}
        .tape-strip{position:absolute;height:20px;background:repeating-linear-gradient(90deg,#ddcc00 0px,#ddcc00 20px,#111 20px,#111 40px);opacity:.15;transform-origin:center}

        /* === HOTSPOT === */
        .hotspot{position:absolute;cursor:pointer;transition:filter .2s;z-index:15}
        .hotspot:hover{filter:brightness(1.3) drop-shadow(0 0 8px rgba(255,200,100,.3))}

        /* === EXIT BUTTON === */
        .exit-btn{position:absolute;bottom:20px;left:20px;padding:10px 22px;background:rgba(25,20,15,.9);border:2px solid #4a3a2a;color:#c4a35a;font-family:'Special Elite',monospace;font-size:13px;cursor:pointer;z-index:300;letter-spacing:2px}
        .exit-btn:hover{background:rgba(50,40,30,.9)}

        /* === UI === */
        #ui{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:500}
        #ui>*{pointer-events:auto}
        #dlg{position:absolute;bottom:50px;left:50%;transform:translateX(-50%);width:90%;max-width:540px;background:rgba(8,6,4,.96);border:2px solid #2d2418;border-left:5px solid #c4a35a;padding:18px 20px;display:none;box-shadow:0 10px 50px rgba(0,0,0,.9)}
        #dlg.vis{display:block}
        .ds{font-family:'Playfair Display',serif;font-size:11px;color:#c4a35a;letter-spacing:4px;margin-bottom:8px;text-transform:uppercase}
        .dt{font-family:'Special Elite',monospace;font-size:15px;color:#d4c5a9;line-height:1.7}
        .dc{font-size:9px;color:#4a3a2a;margin-top:10px;text-align:right;animation:pu 2s ease-in-out infinite}
        #ltitle{position:absolute;top:20px;left:50%;transform:translateX(-50%);font-family:'Playfair Display',serif;font-size:clamp(18px,5vw,28px);font-weight:900;color:#b0a080;letter-spacing:8px;text-transform:uppercase;text-shadow:0 2px 20px rgba(0,0,0,.9);opacity:0;transition:opacity 1s;pointer-events:none}
        #ltitle.show{opacity:1}
        #inv{position:absolute;top:16px;left:16px;display:flex;gap:5px}
        .inv-slot{width:38px;height:38px;background:rgba(15,12,8,.88);border:2px solid #3a2a1a;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer}
        .inv-slot:hover{border-color:#8a7a5a;background:rgba(30,24,16,.9)}
        #case-btn{position:absolute;top:16px;right:16px;padding:6px 14px;background:rgba(15,12,8,.88);border:2px solid #3a2a1a;color:#8a7a5a;font-family:'Special Elite',monospace;font-size:10px;letter-spacing:2px;cursor:pointer}
        #case-btn:hover{border-color:#8a7a5a;color:#c4a35a}
        #case-panel{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:85%;max-width:500px;max-height:70vh;overflow-y:auto;background:#f5f0e6;border:3px solid #3d3428;padding:28px;z-index:600;box-shadow:0 20px 60px rgba(0,0,0,.8);display:none}
        #case-panel.vis{display:block}
        #case-panel h2{font-family:'Playfair Display',serif;color:#2a2015;margin-bottom:16px;border-bottom:2px solid #3d3428;padding-bottom:8px;font-size:16px;letter-spacing:3px}
        .cnote{font-family:'Special Elite',monospace;color:#3a3025;font-size:13px;margin-bottom:10px;padding-left:14px;border-left:3px solid #8a7a5a;line-height:1.5}
        #case-panel .close-x{position:absolute;top:10px;right:14px;font-size:20px;cursor:pointer;color:#3a3025}
        #hint{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:10px;color:#3a2a1a;letter-spacing:2px;white-space:nowrap;transition:opacity 2s}
        #grain{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:.05;z-index:1000;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
        #vig{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;background:radial-gradient(ellipse at center,transparent 30%,rgba(0,0,0,.75) 100%);z-index:999}

        /* === TITLE === */
        #title{position:fixed;top:0;left:0;width:100%;height:100%;background:#060506;z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:opacity 1.8s;overflow:hidden}
        #title.gone{opacity:0;pointer-events:none}
        .tcol{position:absolute;top:0;left:0;width:100%;height:100%;opacity:.15}
        .tcol img{width:100%;height:100%;object-fit:cover;filter:grayscale(100%) contrast(1.8) brightness(.4)}
        #title h1{font-family:'Playfair Display',serif;font-weight:900;font-size:clamp(48px,16vw,140px);color:transparent;-webkit-text-stroke:2px #8a7050;letter-spacing:12px;z-index:1}
        #title .sub{font-family:'Special Elite',monospace;font-size:clamp(10px,3vw,16px);color:#2a1a0a;letter-spacing:10px;margin-top:15px;z-index:1}
        #title .tag{font-family:'Special Elite',monospace;font-size:clamp(8px,2vw,12px);color:#1a1008;letter-spacing:3px;margin-top:30px;max-width:80%;text-align:center;line-height:1.8;z-index:1}
        #title .tap{font-size:11px;color:#1a0a00;letter-spacing:4px;margin-top:50px;animation:pu 2.5s ease-in-out infinite;z-index:1}
        #title .yr{position:absolute;bottom:25px;font-family:'Playfair Display',serif;font-size:14px;color:#140a00;letter-spacing:5px;z-index:1}
    </style>
</head>
<body>
<div id="game">

<!-- ============ STREET ============ -->
<div id="sc-street" class="scene active">
    <div class="photo-bg"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Gottlieb_52nd_Street.jpg/1280px-Gottlieb_52nd_Street.jpg" alt="52nd Street NYC, Gottlieb 1948" crossorigin="anonymous" onerror="this.parentElement.style.background='linear-gradient(to bottom,#080810,#121220,#0a0a14)'"></div>
    <div class="bg-fade"></div><div class="bg-side"></div>
    <div class="moon"></div>
    <div class="bldg-layer">
        <div class="bs b1"></div><div class="bs b2"></div><div class="bs b3"></div><div class="bs b4"></div><div class="bs b5"></div>
        <div class="w" style="bottom:65%;left:4%;width:5px;height:7px"></div>
        <div class="w" style="bottom:58%;left:7%;width:4px;height:6px;animation-delay:-1s"></div>
        <div class="w" style="bottom:70%;left:11%;width:5px;height:7px;animation-delay:-2s"></div>
        <div class="w" style="bottom:55%;left:14%;width:4px;height:5px;animation-delay:-3s"></div>
        <div class="w" style="bottom:68%;left:22%;width:5px;height:8px;animation-delay:-.5s"></div>
        <div class="w" style="bottom:60%;left:25%;width:4px;height:6px;animation-delay:-1.5s"></div>
        <div class="w" style="bottom:72%;left:30%;width:5px;height:7px;animation-delay:-2.5s"></div>
        <div class="w" style="bottom:63%;left:34%;width:4px;height:6px;animation-delay:-3.5s"></div>
        <div class="w" style="bottom:75%;left:42%;width:5px;height:8px;animation-delay:-.8s"></div>
        <div class="w" style="bottom:66%;left:46%;width:4px;height:6px;animation-delay:-1.8s"></div>
        <div class="w" style="bottom:70%;left:50%;width:5px;height:7px;animation-delay:-2.8s"></div>
        <div class="w" style="bottom:58%;left:54%;width:4px;height:5px;animation-delay:-.3s"></div>
        <div class="w" style="bottom:62%;left:66%;width:5px;height:7px;animation-delay:-1.3s"></div>
        <div class="w" style="bottom:55%;left:70%;width:4px;height:6px;animation-delay:-2.3s"></div>
        <div class="w" style="bottom:68%;left:84%;width:5px;height:7px;animation-delay:-3.3s"></div>
        <div class="w" style="bottom:60%;left:88%;width:4px;height:6px;animation-delay:-.7s"></div>
        <div class="w" style="bottom:73%;left:92%;width:5px;height:7px;animation-delay:-1.7s"></div>
    </div>
    <div class="neon nr" style="top:26%;left:8%" data-door="bar">BAR</div>
    <div class="neon nbl" style="top:16%;left:54%" data-door="hotel">AVALON<br><span style="font-size:60%;letter-spacing:3px">HOTEL</span></div>
    <div class="neon na" style="top:28%;right:7%">EATS</div>
    <div class="neon ng" style="top:24%;left:40%">DRUGS</div>
    <div class="neon sp" style="top:20%;left:31%" data-door="office">NOIR INVESTIGATIONS<br><span style="font-size:85%;opacity:.6">3rd Floor</span></div>
    <div class="nr-ref" style="left:9%;width:60px;height:18%;background:linear-gradient(to bottom,rgba(255,30,30,.12),transparent);animation-delay:-.5s"></div>
    <div class="nr-ref" style="left:55%;width:50px;height:18%;background:linear-gradient(to bottom,rgba(60,130,255,.1),transparent);animation-delay:-1.5s"></div>
    <div class="nr-ref" style="right:8%;width:45px;height:18%;background:linear-gradient(to bottom,rgba(255,170,50,.08),transparent);animation-delay:-2.5s"></div>
    <div class="st-ground"><div class="sidewalk"></div></div>
    <div class="lamp" style="left:22%"><div class="lh"></div><div class="lp"></div><div class="lpool"></div></div>
    <div class="lamp" style="left:65%"><div class="lh"></div><div class="lp"></div><div class="lpool"></div></div>
    <div class="car-cut" id="obj-car"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/1957_Chevrolet_Bel_Air_Sport_Sedan_%2826233032368%29.jpg/640px-1957_Chevrolet_Bel_Air_Sport_Sedan_%2826233032368%29.jpg" alt="1957 Chevrolet" crossorigin="anonymous" onerror="this.style.display='none';this.parentElement.style.background='#080808';this.parentElement.style.clipPath='polygon(0% 100%,0% 55%,5% 40%,20% 25%,40% 8%,65% 5%,85% 20%,100% 45%,100% 100%)'"><span class="ipip">?</span></div>
    <div class="clue cl-paper" id="clue-newspaper" data-item="newspaper"><div class="pt">DAILY HERALD</div><div class="ph">WOMAN FOUND DEAD AT AVALON HOTEL</div><div class="pp">Police have ruled the death a suicide but sources close to the investigation suggest foul play cannot be ruled out...</div><span class="ipip" style="top:-16px">!</span></div>
    <div class="clue cl-match" id="clue-matchbook" data-item="matchbook"><div class="mt">THE<br>BLUE<br>MOON</div><span class="ipip" style="top:-16px">!</span></div>
    <div class="door-zone" data-door="bar" data-label="ENTER BAR" style="bottom:20%;left:6%;width:9%;height:18%;background:rgba(255,30,30,.03)"></div>
    <div class="door-zone" data-door="office" data-label="ENTER OFFICE" style="bottom:20%;left:30%;width:8%;height:16%;background:rgba(180,160,120,.03)"></div>
    <div class="door-zone" data-door="hotel" data-label="ENTER HOTEL" style="bottom:20%;left:55%;width:8%;height:16%;background:rgba(60,130,255,.03)"></div>
    <div class="ch viv idle" id="npc-vivian" style="left:36%;bottom:20%" data-npc="vivian">
        <div class="pb"><img src="https://upload.wikimedia.org/wikipedia/commons/2/29/Lizabeth_Scott-publicity.JPG" alt="Femme Fatale" crossorigin="anonymous" onerror="this.style.display='none';this.parentElement.style.background='linear-gradient(to bottom,#1a1018,#0e0810)';this.parentElement.style.clipPath='polygon(35% 0%,65% 0%,70% 15%,72% 40%,78% 100%,22% 100%,28% 40%,30% 15%)'"></div>
        <div class="csmoke"></div><div class="csmoke"></div><div class="csmoke"></div>
        <div class="cshadow"></div><span class="ipip">?</span>
    </div>
    <div class="ch idle" id="player" style="left:16%;bottom:20%">
        <div class="pb"><img src="https://upload.wikimedia.org/wikipedia/commons/4/43/Humphrey_Bogart_1945.JPG" alt="Detective" crossorigin="anonymous" onerror="this.style.display='none';this.parentElement.style.background='linear-gradient(to bottom,#0e0c0a,#080606)';this.parentElement.style.clipPath='polygon(30% 0%,70% 0%,78% 10%,85% 30%,100% 35%,95% 90%,70% 100%,30% 100%,5% 90%,0% 35%,15% 30%,22% 10%)'"></div>
        <div class="cshadow"></div>
    </div>
</div>

<!-- ============ BAR ============ -->
<div id="sc-bar" class="scene">
    <div class="bar-wall"></div>
    <div class="bar-mirror"></div>
    <div class="bar-shelf" style="top:12%;left:8%;width:84%;height:20%">
        <div class="bottle" style="left:5%;top:20%;width:12px;height:55%;background:linear-gradient(#3a2010,#2a1508)"></div>
        <div class="bottle" style="left:15%;top:30%;width:10px;height:45%;background:linear-gradient(#1a3020,#0a2010)"></div>
        <div class="bottle" style="left:25%;top:15%;width:14px;height:60%;background:linear-gradient(#3a3020,#2a2010)"></div>
        <div class="bottle" style="left:38%;top:25%;width:11px;height:50%;background:linear-gradient(#2a1515,#1a0a0a)"></div>
        <div class="bottle" style="left:50%;top:20%;width:13px;height:55%;background:linear-gradient(#302a18,#201a08)"></div>
        <div class="bottle" style="left:63%;top:30%;width:10px;height:45%;background:linear-gradient(#1a2a30,#0a1a20)"></div>
        <div class="bottle" style="left:75%;top:18%;width:12px;height:57%;background:linear-gradient(#3a2518,#2a1508)"></div>
        <div class="bottle" style="left:88%;top:25%;width:11px;height:50%;background:linear-gradient(#2a2020,#1a1010)"></div>
    </div>
    <div class="bar-shelf" style="top:35%;left:8%;width:84%;height:18%">
        <div class="bottle" style="left:8%;top:15%;width:13px;height:60%;background:linear-gradient(#2a2518,#1a1508)"></div>
        <div class="bottle" style="left:22%;top:25%;width:10px;height:50%;background:linear-gradient(#1a2520,#0a1510)"></div>
        <div class="bottle" style="left:35%;top:20%;width:14px;height:55%;background:linear-gradient(#3a1518,#2a0508)"></div>
        <div class="bottle" style="left:50%;top:15%;width:12px;height:60%;background:linear-gradient(#302518,#201508)"></div>
        <div class="bottle" style="left:65%;top:30%;width:11px;height:45%;background:linear-gradient(#2a2a20,#1a1a10)"></div>
        <div class="bottle" style="left:80%;top:20%;width:13px;height:55%;background:linear-gradient(#352a18,#251a08)"></div>
    </div>
    <div class="beer-sign">Schlitz</div>
    <div class="bar-counter"></div>
    <div class="stool" style="left:18%"><div class="stool-t"></div><div class="stool-l"></div></div>
    <div class="stool" style="left:32%"><div class="stool-t"></div><div class="stool-l"></div></div>
    <div class="stool" style="left:55%"><div class="stool-t"></div><div class="stool-l"></div></div>
    <div class="stool" style="left:72%"><div class="stool-t"></div><div class="stool-l"></div></div>
    <div class="bar-floor"></div>
    <!-- Bartender -->
    <div class="ch bart idle" id="npc-bartender" style="left:42%;bottom:35%" data-npc="bartender">
        <div class="bart-face"></div>
        <div class="pb"><div class="bart-apron"></div></div>
        <div class="bart-towel"></div>
        <span class="ipip">?</span>
    </div>
    <!-- Bar clue: lipstick glass -->
    <div class="hotspot" id="obj-glass" data-look="glass" style="bottom:33%;left:62%;width:14px;height:22px;background:linear-gradient(to bottom,transparent,rgba(200,180,140,.3));border-radius:2px 2px 0 0;border:1px solid rgba(200,180,140,.2)">
        <div style="position:absolute;top:30%;left:0;width:100%;height:4px;background:rgba(150,20,20,.5);border-radius:1px"></div>
        <span class="ipip" style="top:-18px">!</span>
    </div>
    <button class="exit-btn" data-exit="street">EXIT</button>
</div>

<!-- ============ PI OFFICE ============ -->
<div id="sc-office" class="scene">
    <div class="off-wall"></div>
    <div class="off-win"><div class="blinds"></div></div>
    <div class="light-rays"></div>
    <div class="off-desk"></div>
    <div class="off-chair"><div class="ch-back"></div><div class="ch-seat"></div></div>
    <div class="typewriter-cut" id="obj-typewriter" data-look="typewriter">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Underwoodfive.jpg/320px-Underwoodfive.jpg" alt="Underwood Typewriter" crossorigin="anonymous" onerror="this.style.display='none';this.parentElement.style.background='#1a1a1a';this.parentElement.style.borderRadius='5px 5px 0 0'">
        <span class="ipip">?</span>
    </div>
    <div class="desk-lamp"><div class="ls"></div><div class="la"></div><div class="lcone"></div></div>
    <div class="off-filing" id="obj-filing" data-look="filing"><div class="fdr"></div><div class="fdr"></div><div class="fdr"></div><span class="ipip">?</span></div>
    <!-- Phone -->
    <div class="hotspot" id="obj-phone-office" data-look="phone_office" style="bottom:32%;right:25%;width:30px;height:18px;background:#1a1a1a;border-radius:3px">
        <div style="position:absolute;top:-8px;left:2px;width:26px;height:8px;background:#1a1a1a;border-radius:8px 8px 0 0"></div>
        <span class="ipip">?</span>
    </div>
    <div class="off-floor"></div>
    <button class="exit-btn" data-exit="street">EXIT</button>
</div>

<!-- ============ HOTEL LOBBY ============ -->
<div id="sc-hotel" class="scene">
    <div class="hotel-wall"></div>
    <div class="hotel-sign">AVALON HOTEL</div>
    <div class="hotel-keys">
        <div class="key-hook" style="left:15%;top:20%" data-room="201">201</div>
        <div class="key-hook" style="left:30%;top:20%" data-room="208">208</div>
        <div class="key-hook empty" style="left:45%;top:20%;opacity:.4" data-room="214">214</div>
        <div class="key-hook" style="left:60%;top:20%" data-room="220">220</div>
        <div class="key-hook" style="left:75%;top:20%" data-room="225">225</div>
        <div class="key-hook" style="left:15%;top:60%" data-room="301">301</div>
        <div class="key-hook" style="left:30%;top:60%" data-room="305">305</div>
        <div class="key-hook" style="left:45%;top:60%" data-room="310">310</div>
        <div class="key-hook" style="left:60%;top:60%" data-room="315">315</div>
        <div class="key-hook" style="left:75%;top:60%" data-room="322">322</div>
    </div>
    <div class="hotel-desk"></div>
    <div class="hotel-column" style="left:10%;height:55%"></div>
    <div class="hotel-column" style="right:10%;height:55%"></div>
    <div class="hotel-painting" style="top:15%;left:5%">
        <div style="width:100%;height:100%;background:linear-gradient(135deg,#2a3a2a,#1a2a1a)"></div>
    </div>
    <div class="hotel-painting" style="top:18%;right:5%">
        <div style="width:100%;height:100%;background:linear-gradient(135deg,#3a2a2a,#2a1a1a)"></div>
    </div>
    <div class="hotel-carpet"></div>
    <!-- Hotel Clerk -->
    <div class="ch idle" id="npc-clerk" style="left:42%;bottom:32%" data-npc="clerk">
        <div class="pb" style="width:clamp(40px,6vw,50px);height:clamp(100px,16vw,125px);background:linear-gradient(to bottom,#2a2828,#1a1818);clip-path:polygon(25% 0%,75% 0%,80% 12%,85% 40%,82% 100%,18% 100%,15% 40%,20% 12%)"></div>
        <div style="position:absolute;top:3%;left:50%;transform:translateX(-50%);width:45%;height:14%;background:linear-gradient(to bottom,#b09070,#987858);border-radius:3px 3px 5px 5px;z-index:2"></div>
        <span class="ipip">?</span>
    </div>
    <!-- Guest register -->
    <div class="hotspot" id="obj-register" data-look="register" style="bottom:31%;left:35%;width:50px;height:8px;background:#e8e0d0;box-shadow:1px 1px 3px rgba(0,0,0,.4)">
        <span class="ipip" style="top:-18px">!</span>
    </div>
    <!-- Door to Room 214 -->
    <div class="door-zone" data-door="room214" data-label="ROOM 214" style="top:15%;left:42%;width:12%;height:25%;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05)"></div>
    <button class="exit-btn" data-exit="street">EXIT</button>
</div>

<!-- ============ ROOM 214 ============ -->
<div id="sc-room" class="scene">
    <div class="room-wall"></div>
    <div class="room-tape">
        <div class="tape-strip" style="top:30%;left:-5%;width:110%;transform:rotate(2deg)"></div>
        <div class="tape-strip" style="top:45%;left:-5%;width:110%;transform:rotate(-1deg)"></div>
    </div>
    <div class="room-window">
        <div class="room-curtain-l"></div>
        <div class="room-curtain-r"></div>
        <div style="position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,#0a1520,#050a10)"></div>
    </div>
    <div class="room-bed">
        <div class="bed-pillow"></div>
        <div class="bed-sheet"></div>
    </div>
    <div class="chalk-outline"></div>
    <div class="room-table">
        <div class="room-phone" id="obj-phone" data-look="phone"></div>
    </div>
    <!-- Evidence markers -->
    <div class="evidence-marker" id="ev-1" data-look="evidence1" style="bottom:25%;left:25%">1</div>
    <div class="evidence-marker" id="ev-2" data-look="evidence2" style="bottom:30%;left:55%">2</div>
    <div class="evidence-marker" id="ev-3" data-look="evidence3" style="bottom:22%;right:20%">3</div>
    <!-- Diary clue on table -->
    <div class="hotspot" id="obj-diary" data-item="diary" style="bottom:37%;right:15%;width:28px;height:35px;background:linear-gradient(to bottom,#4a2020,#3a1515);border-radius:2px;box-shadow:1px 2px 4px rgba(0,0,0,.5)">
        <div style="position:absolute;top:30%;left:15%;width:70%;height:2px;background:rgba(200,180,140,.3)"></div>
        <div style="position:absolute;top:45%;left:15%;width:50%;height:2px;background:rgba(200,180,140,.2)"></div>
        <div style="position:absolute;top:60%;left:15%;width:60%;height:2px;background:rgba(200,180,140,.25)"></div>
        <span class="ipip" style="top:-18px">!</span>
    </div>
    <div class="room-floor"></div>
    <button class="exit-btn" data-exit="hotel">EXIT</button>
</div>

<!-- ============ UI ============ -->
<div id="ui">
    <div id="ltitle"></div>
    <div id="dlg"><div class="ds"></div><div class="dt"></div><div class="dc">tap to continue</div></div>
    <div id="inv"></div>
    <button id="case-btn">CASE NOTES</button>
    <div id="case-panel"><span class="close-x">&times;</span><h2>CASE NOTES</h2><div id="notes-list"></div></div>
    <div id="hint">CLICK TO MOVE &bull; CLICK OBJECTS TO INTERACT</div>
</div>
<div id="vig"></div><div id="grain"></div>

<!-- TITLE -->
<div id="title">
    <div class="tcol"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Gottlieb_52nd_Street.jpg/1280px-Gottlieb_52nd_Street.jpg" alt="" crossorigin="anonymous"></div>
    <h1>NIGHTFALL</h1>
    <div class="sub">A COLLAGE NOIR</div>
    <div class="tag">A woman is dead. The police say suicide.<br>Her sister says murder. You say fifty a day plus expenses.</div>
    <div class="tap">TAP TO BEGIN</div>
    <div class="yr">1 9 5 9</div>
</div>
</div>

<script>
// ==========================================
// GAME ENGINE
// ==========================================
const G = {
    scene: 'street',
    px: 16,
    inv: [],
    flags: {},
    notes: [],
    dq: [],
    di: 0,
    moving: false
};

// ==========================================
// DIALOGUE DATABASE
// ==========================================
const D = {
    vivian_intro: [
        {s:"???",t:"You must be the detective. I\u2019ve heard you take cases the police won\u2019t touch."},
        {s:"VIVIAN MARLOWE",t:"My name is Vivian. My sister Eleanor was found dead this morning at the Avalon Hotel. Room 214."},
        {s:"VIVIAN",t:"They\u2019re calling it suicide. Eleanor would never do that. She was afraid of something\u2014someone."},
        {s:"VIVIAN",t:"I need you to find who really killed her. I\u2019ll pay whatever it takes."},
        {s:"YOU",t:"Who were her friends? Enemies?"},
        {s:"VIVIAN",t:"Start at the Blue Moon bar. She spent her last evening there. Ask for a man called Mickey."},
        {s:"VIVIAN",t:"And detective\u2014be careful. Eleanor told me she was being followed."}
    ],
    vivian_return: [
        {s:"VIVIAN",t:"Have you spoken to Mickey yet?"},
        {s:"YOU",t:"Working on it. These things take time, Miss Marlowe."},
        {s:"VIVIAN",t:"Time is something Eleanor doesn\u2019t have anymore."}
    ],
    vivian_progress: [
        {s:"VIVIAN",t:"What have you found?"},
        {s:"YOU",t:"Your sister was meeting someone at the Blue Moon. Big man, gray suit. Works for someone named Castellano."},
        {s:"VIVIAN",t:"Castellano\u2026 Eleanor mentioned that name. She was terrified of him."},
        {s:"VIVIAN",t:"He runs half the waterfront. Real estate, shipping. The kind of man who makes problems disappear."},
        {s:"YOU",t:"Including your sister?"},
        {s:"VIVIAN",t:"Find the proof, detective. That\u2019s what I\u2019m paying you for."}
    ],
    bartender_intro: [
        {s:"MICKEY",t:"What can I get ya?"},
        {s:"YOU",t:"Information. I\u2019m looking into the Marlowe case."},
        {s:"MICKEY",t:"Eleanor? She was in here last night. Looked scared. Kept watching the door."},
        {s:"MICKEY",t:"She was meeting someone. Big guy, gray suit. Expensive. They argued."},
        {s:"YOU",t:"You get a name?"},
        {s:"MICKEY",t:"Didn\u2019t catch one. But he dropped a business card when he left. I still got it."},
        {s:"MICKEY",t:"Here. \u2018Vincent Castellano \u2013 Castellano Holdings.\u2019 Guy\u2019s connected. Watch your back."}
    ],
    bartender_return: [
        {s:"MICKEY",t:"Still working that case?"},
        {s:"YOU",t:"Castellano. Where do I find him?"},
        {s:"MICKEY",t:"You don\u2019t find Castellano. He finds you. That\u2019s usually bad news."},
        {s:"MICKEY",t:"But his office is on the fifth floor of the Harbor Building. Downtown."}
    ],
    bartender_late: [
        {s:"MICKEY",t:"You look like a man who\u2019s seen a ghost."},
        {s:"YOU",t:"Worse. I\u2019ve seen the truth."},
        {s:"MICKEY",t:"That\u2019ll do it. Drink?"}
    ],
    clerk_intro: [
        {s:"HOTEL CLERK",t:"Can I help you, sir?"},
        {s:"YOU",t:"I\u2019m investigating the death in room 214. Eleanor Marlowe."},
        {s:"CLERK",t:"The police already came and went. Said it was suicide. Case closed."},
        {s:"YOU",t:"I\u2019m not the police. Her sister hired me. I need to see that room."},
        {s:"CLERK",t:"I\u2019m not supposed to let anyone up there\u2026"},
        {s:"YOU",t:"Twenty dollars says you can make an exception."},
        {s:"CLERK",t:"\u2026Second floor. End of the hall on the right. The key\u2019s missing but the door\u2019s unlocked. Police were sloppy."}
    ],
    clerk_return: [
        {s:"CLERK",t:"Find what you were looking for up there?"},
        {s:"YOU",t:"Still looking. Did anyone visit her that night?"},
        {s:"CLERK",t:"A man came in around 10 PM. Big. Gray suit. Didn\u2019t sign the register."},
        {s:"CLERK",t:"He left about an hour later. Walking fast. Didn\u2019t look at me."}
    ],
    car: [
        {s:"NARRATOR",t:"A \u201957 Bel Air. Chrome catching neon like fresh blood on a switchblade."},
        {s:"NARRATOR",t:"Someone parked in a hurry. The door\u2019s not quite closed. Expensive shoes scuffed the running board."}
    ],
    newspaper: [
        {s:"NARRATOR",t:"Today\u2019s Daily Herald. Front page: \u2018WOMAN FOUND DEAD AT AVALON HOTEL.\u2019"},
        {s:"NARRATOR",t:"Police calling it suicide. Funny how suicides don\u2019t usually have bruises on their wrists."}
    ],
    matchbook: [
        {s:"NARRATOR",t:"A matchbook. \u2018The Blue Moon\u2019 in gold on crimson."},
        {s:"NARRATOR",t:"Barely damp. Dropped tonight. Someone was here recently who knows the bar."}
    ],
    hotel_locked: [
        {s:"NARRATOR",t:"The Avalon Hotel. Room 214 is up there somewhere behind dark curtains."},
        {s:"NARRATOR",t:"I\u2019ll need to talk to someone to get inside. Maybe try the bar first."}
    ],
    hotel_open: [
        {s:"NARRATOR",t:"The Avalon Hotel. The clerk might let me in now that I know what I\u2019m looking for."}
    ],
    typewriter: [
        {s:"NARRATOR",t:"My old Underwood. The \u2018e\u2019 key sticks, but it still tells the truth."},
        {s:"NARRATOR",t:"Half-finished case reports. Unpaid bills. A bottle of rye in the drawer."}
    ],
    filing: [
        {s:"NARRATOR",t:"Case files. Most of them cold. Just like the trails that led nowhere."},
        {s:"NARRATOR",t:"Eleanor Marlowe\u2019s folder is empty. Time to change that."}
    ],
    phone_office: [
        {s:"NARRATOR",t:"The phone. Dead line. Nobody\u2019s calling with good news at this hour."}
    ],
    glass: [
        {s:"NARRATOR",t:"A whiskey glass with lipstick on the rim. Deep red. Eleanor\u2019s shade."},
        {s:"NARRATOR",t:"She was sitting right here, hours before she died. The stool\u2019s still warm."}
    ],
    register: [
        {s:"NARRATOR",t:"The guest register. Eleanor checked in two days ago. Room 214."},
        {s:"NARRATOR",t:"No visitors logged. But the ink on last night\u2019s entries is smudged. Someone tore out a page."}
    ],
    phone: [
        {s:"NARRATOR",t:"Hotel phone. The receiver is off the hook."},
        {s:"NARRATOR",t:"The last number dialed is still on the rotary. A downtown exchange. Castellano\u2019s office."}
    ],
    evidence1: [
        {s:"NARRATOR",t:"Marker 1. A single earring. Pearl. Expensive. Ripped from the lobe."},
        {s:"NARRATOR",t:"This wasn\u2019t suicide. This was a struggle."}
    ],
    evidence2: [
        {s:"NARRATOR",t:"Marker 2. Scuff marks on the hardwood. Two sets of shoes. One large, one small."},
        {s:"NARRATOR",t:"Someone dragged her. The smaller prints lead to the window."}
    ],
    evidence3: [
        {s:"NARRATOR",t:"Marker 3. A cufflink under the nightstand. Monogrammed. \u2018V.C.\u2019"},
        {s:"NARRATOR",t:"Vincent Castellano. He was here. And now Eleanor Marlowe is dead."}
    ],
    diary: [
        {s:"NARRATOR",t:"A leather diary. Eleanor\u2019s handwriting."},
        {s:"NARRATOR",t:"\u2018V. won\u2019t stop calling. He says if I talk to anyone about the Harbor deal, I\u2019ll regret it.\u2019"},
        {s:"NARRATOR",t:"\u2018I told Vivian to hire someone if anything happens to me. Someone who can\u2019t be bought.\u2019"},
        {s:"NARRATOR",t:"The last entry is dated yesterday. The ink is still fresh. She knew she was in danger."}
    ],
    room214_locked: [
        {s:"NARRATOR",t:"Room 214. The door is closed. I need to talk to the clerk first."}
    ],
    case_solved: [
        {s:"NARRATOR",t:"The cufflink. The diary. The phone records. The witness at the bar. The torn register page."},
        {s:"NARRATOR",t:"Vincent Castellano killed Eleanor Marlowe because she knew about the Harbor deal."},
        {s:"NARRATOR",t:"Not suicide. Murder. And now I have enough to prove it."},
        {s:"NARRATOR",t:"Time to make a phone call to someone at the Herald who isn\u2019t on Castellano\u2019s payroll."},
        {s:"NARRATOR",t:"Eleanor Marlowe deserved better than a chalk outline and a closed case."},
        {s:"NARRATOR",t:"CASE CLOSED."}
    ]
};

// ==========================================
// DOM
// ==========================================
const $ = id => document.getElementById(id);
const player = $('player');
const dlg = $('dlg');
const loc = $('ltitle');

// ==========================================
// SCENE MANAGEMENT
// ==========================================
function goScene(id) {
    document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
    const el = $('sc-' + id);
    if (!el) return;
    el.classList.add('active');
    G.scene = id;
    const names = {
        street: 'MAIN STREET',
        bar: 'THE BLUE MOON',
        office: 'NOIR INVESTIGATIONS',
        hotel: 'AVALON HOTEL',
        room: 'ROOM 214'
    };
    showLoc(names[id] || id.toUpperCase());
}

function showLoc(name) {
    loc.textContent = name;
    loc.classList.add('show');
    setTimeout(() => loc.classList.remove('show'), 3000);
}

// ==========================================
// PLAYER MOVEMENT
// ==========================================
function movePlayer(tx, cb) {
    if (G.moving) return;
    const dx = Math.abs(tx - G.px);
    if (dx < 2) { if (cb) cb(); return; }
    G.moving = true;
    player.classList.replace('idle', 'walking');
    player.style.transform = tx < G.px ? 'scaleX(-1)' : 'scaleX(1)';
    const ms = dx * 28;
    player.style.transition = 'left ' + ms + 'ms linear';
    player.style.left = tx + '%';
    G.px = tx;
    setTimeout(() => {
        G.moving = false;
        player.classList.replace('walking', 'idle');
        player.style.transition = '';
        if (cb) cb();
    }, ms);
}

// ==========================================
// DIALOGUE
// ==========================================
function talk(key, afterFn) {
    if (!D[key]) return;
    G.dq = D[key];
    G.di = 0;
    G._afterTalk = afterFn || null;
    showLine();
}

function showLine() {
    if (G.di >= G.dq.length) { closeDlg(); return; }
    const l = G.dq[G.di];
    dlg.querySelector('.ds').textContent = l.s;
    dlg.querySelector('.dt').textContent = l.t;
    dlg.classList.add('vis');
}

function advDlg() { G.di++; showLine(); }

function closeDlg() {
    dlg.classList.remove('vis');
    G.dq = []; G.di = 0;
    document.querySelectorAll('.talking').forEach(e => { e.classList.remove('talking'); e.classList.add('idle'); });
    if (G._afterTalk) { const fn = G._afterTalk; G._afterTalk = null; fn(); }
    checkCaseSolved();
}

// ==========================================
// NPC INTERACTION
// ==========================================
function talkNPC(id) {
    const el = $(id);
    if (!el) return;
    el.classList.remove('idle');
    el.classList.add('talking');
    const npc = el.dataset.npc;

    if (npc === 'vivian') {
        if (!G.flags.met_vivian) {
            talk('vivian_intro', () => { addNote('Vivian Marlowe hired me to investigate her sister Eleanor\u2019s death at the Avalon Hotel.'); addNote('Eleanor was found dead in Room 214. Police say suicide.'); addNote('Vivian says: start at the Blue Moon bar, ask for Mickey.'); });
            G.flags.met_vivian = true;
        } else if (G.flags.talked_bart) {
            talk('vivian_progress', () => { addNote('Vivian confirms: Castellano runs the waterfront. Eleanor was terrified of him.'); });
        } else {
            talk('vivian_return');
        }
    }
    else if (npc === 'bartender') {
        if (!G.flags.talked_bart) {
            talk('bartender_intro', () => { addNote('Mickey says Eleanor was at the bar last night. Scared. Meeting a big man in a gray suit.'); addNote('Business card found: Vincent Castellano \u2013 Castellano Holdings.'); G.flags.hotel_access = true; });
            G.flags.talked_bart = true;
        } else if (G.flags.found_cufflink) {
            talk('bartender_late');
        } else {
            talk('bartender_return', () => { addNote('Mickey says Castellano\u2019s office is in the Harbor Building, 5th floor.'); });
        }
    }
    else if (npc === 'clerk') {
        if (!G.flags.talked_clerk) {
            if (!G.flags.talked_bart) {
                talk('hotel_locked');
                return;
            }
            talk('clerk_intro', () => { addNote('Hotel clerk let me into Room 214 for $20.'); addNote('Key to 214 is missing. Door unlocked. Police were sloppy.'); G.flags.room_access = true; });
            G.flags.talked_clerk = true;
        } else {
            talk('clerk_return', () => { addNote('Clerk confirms: a big man in a gray suit visited Eleanor around 10 PM. Left an hour later. Walking fast.'); });
        }
    }
}

// ==========================================
// COLLECTIBLES & LOOKABLES
// ==========================================
function collect(el, itemId) {
    if (G.inv.includes(itemId)) return;
    G.inv.push(itemId);
    el.style.transition = 'opacity .5s,transform .5s';
    el.style.opacity = '0';
    el.style.transform = 'scale(.5) rotate(10deg)';
    setTimeout(() => el.style.display = 'none', 500);
    talk(itemId, () => {
        if (itemId === 'newspaper') addNote('Newspaper: Eleanor Marlowe found dead. \u201cSuicide.\u201d Bruises on wrists suggest otherwise.');
        if (itemId === 'matchbook') addNote('Blue Moon matchbook found on the street. Dropped recently.');
        if (itemId === 'diary') { addNote('Eleanor\u2019s diary: Castellano threatened her about the \u201cHarbor deal.\u201d'); addNote('Eleanor told Vivian to hire someone if anything happened. She knew she was in danger.'); G.flags.found_diary = true; }
    });
    renderInv();
}

function lookAt(key) {
    talk(key, () => {
        if (key === 'glass') { addNote('Lipstick on whiskey glass at the bar. Eleanor was here.'); G.flags.found_glass = true; }
        if (key === 'register') { addNote('Hotel register: Eleanor checked in 2 days ago. Last night\u2019s page torn out.'); G.flags.found_register = true; }
        if (key === 'phone') { addNote('Hotel phone off the hook. Last number dialed: Castellano\u2019s office.'); G.flags.found_phone = true; }
        if (key === 'evidence1') { addNote('Evidence #1: Pearl earring ripped from earlobe. This was a struggle, not suicide.'); G.flags.found_earring = true; }
        if (key === 'evidence2') { addNote('Evidence #2: Two sets of shoe scuffs. Someone dragged her toward the window.'); G.flags.found_scuffs = true; }
        if (key === 'evidence3') { addNote('Evidence #3: Cufflink monogrammed \u201cV.C.\u201d \u2014 Vincent Castellano was in this room.'); G.flags.found_cufflink = true; }
    });
}

function renderInv() {
    const el = $('inv');
    el.innerHTML = '';
    const icons = { newspaper:'\u{1F4F0}', matchbook:'\u{1F525}', diary:'\u{1F4D5}' };
    G.inv.forEach(i => {
        const d = document.createElement('div');
        d.className = 'inv-slot';
        d.textContent = icons[i] || '?';
        d.title = i;
        el.appendChild(d);
    });
}

// ==========================================
// CASE NOTES
// ==========================================
function addNote(text) {
    if (G.notes.includes(text)) return;
    G.notes.push(text);
    renderNotes();
}

function renderNotes() {
    const el = $('notes-list');
    el.innerHTML = '';
    G.notes.forEach(n => {
        const d = document.createElement('div');
        d.className = 'cnote';
        d.textContent = n;
        el.appendChild(d);
    });
}

// ==========================================
// WIN CONDITION
// ==========================================
function checkCaseSolved() {
    if (G.flags.case_solved) return;
    if (G.flags.found_cufflink && G.flags.found_diary && G.flags.found_phone) {
        G.flags.case_solved = true;
        setTimeout(() => {
            talk('case_solved', () => {
                addNote('\u2014\u2014\u2014 CASE CLOSED \u2014\u2014\u2014');
                addNote('Vincent Castellano murdered Eleanor Marlowe to silence her about the Harbor real estate deal.');
                addNote('Evidence: cufflink, diary, phone records, witness testimony, torn hotel register.');
            });
        }, 1000);
    }
}

// ==========================================
// INPUT SETUP
// ==========================================
function init() {
    // Title
    $('title').addEventListener('click', () => {
        $('title').classList.add('gone');
        showLoc('MAIN STREET');
        setTimeout(() => $('hint').style.opacity = '0', 6000);
    });

    // Street click-to-move
    $('sc-street').addEventListener('click', e => {
        if (dlg.classList.contains('vis')) { advDlg(); return; }
        const r = $('sc-street').getBoundingClientRect();
        const x = ((e.clientX - r.left) / r.width) * 100;
        movePlayer(Math.max(3, Math.min(93, x)));
    });

    // NPCs
    document.querySelectorAll('[data-npc]').forEach(n => {
        n.addEventListener('click', e => {
            e.stopPropagation();
            if (dlg.classList.contains('vis')) { advDlg(); return; }
            if (G.scene === 'street') {
                const nx = parseFloat(n.style.left);
                movePlayer(nx - 6, () => talkNPC(n.id));
            } else {
                talkNPC(n.id);
            }
        });
    });

    // Car
    $('obj-car').addEventListener('click', e => {
        e.stopPropagation();
        if (dlg.classList.contains('vis')) { advDlg(); return; }
        talk('car');
    });

    // Lookable objects
    document.querySelectorAll('[data-look]').forEach(o => {
        o.addEventListener('click', e => {
            e.stopPropagation();
            if (dlg.classList.contains('vis')) { advDlg(); return; }
            lookAt(o.dataset.look);
        });
    });

    // Collectible items
    document.querySelectorAll('[data-item]').forEach(c => {
        c.addEventListener('click', e => {
            e.stopPropagation();
            if (dlg.classList.contains('vis')) { advDlg(); return; }
            collect(c, c.dataset.item);
        });
    });

    // Doors & neon signs
    document.querySelectorAll('[data-door]').forEach(d => {
        d.addEventListener('click', e => {
            e.stopPropagation();
            if (dlg.classList.contains('vis')) { advDlg(); return; }
            const t = d.dataset.door;
            if (t === 'bar') goScene('bar');
            else if (t === 'office') goScene('office');
            else if (t === 'hotel') {
                if (G.flags.talked_bart) goScene('hotel');
                else talk('hotel_locked');
            }
            else if (t === 'room214') {
                if (G.flags.room_access) goScene('room');
                else talk('room214_locked');
            }
        });
    });

    // Key hooks in hotel
    document.querySelectorAll('.key-hook').forEach(k => {
        k.addEventListener('click', e => {
            e.stopPropagation();
            if (dlg.classList.contains('vis')) { advDlg(); return; }
            const room = k.dataset.room;
            if (room === '214') {
                if (G.flags.room_access) goScene('room');
                else talk('room214_locked');
            }
        });
    });

    // Exit buttons
    document.querySelectorAll('[data-exit]').forEach(b => {
        b.addEventListener('click', e => {
            e.stopPropagation();
            goScene(b.dataset.exit);
        });
    });

    // Dialogue advance
    dlg.addEventListener('click', e => { e.stopPropagation(); advDlg(); });

    // Interior clicks advance dialogue
    ['sc-bar','sc-office','sc-hotel','sc-room'].forEach(id => {
        $(id).addEventListener('click', e => {
            if (dlg.classList.contains('vis')) advDlg();
        });
    });

    // Case notes
    $('case-btn').addEventListener('click', e => {
        e.stopPropagation();
        $('case-panel').classList.toggle('vis');
    });
    $('case-panel').querySelector('.close-x').addEventListener('click', e => {
        e.stopPropagation();
        $('case-panel').classList.remove('vis');
    });

    // Keyboard
    document.addEventListener('keydown', e => {
        if (e.key === ' ' || e.key === 'Enter') { if (dlg.classList.contains('vis')) advDlg(); }
        if (e.key === 'Escape') { closeDlg(); $('case-panel').classList.remove('vis'); }
        if (e.key === 'n' || e.key === 'N') $('case-panel').classList.toggle('vis');
    });
}

init();
</script>
</body>
</html>
